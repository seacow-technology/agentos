{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "agentos://schemas/tools/tool_task_pack.schema.json",
  "title": "Tool Task Pack (v0.11.2)",
  "description": "Task package for external tools (Claude CLI, OpenCode, etc.)",
  "type": "object",
  "required": [
    "tool_task_pack_id",
    "schema_version",
    "execution_request_id",
    "tool_type",
    "repo_state",
    "work_scope",
    "steps",
    "prompt_pack",
    "acceptance",
    "created_at"
  ],
  "properties": {
    "tool_task_pack_id": {
      "type": "string",
      "pattern": "^ttpack_[a-z0-9_]{6,64}$",
      "description": "Unique tool task pack ID"
    },
    "schema_version": {
      "type": "string",
      "const": "0.11.2"
    },
    "execution_request_id": {
      "type": "string",
      "description": "Source execution request ID"
    },
    "tool_type": {
      "type": "string",
      "enum": ["claude_cli", "opencode", "codex", "custom"],
      "description": "Type of external tool"
    },
    "repo_state": {
      "type": "object",
      "required": ["branch", "commit_hash", "is_dirty"],
      "properties": {
        "branch": {"type": "string"},
        "commit_hash": {"type": "string", "pattern": "^[a-f0-9]{40}$"},
        "is_dirty": {"type": "boolean"},
        "remote_url": {"type": "string"}
      },
      "description": "Current repository state"
    },
    "work_scope": {
      "type": "object",
      "required": ["allowed_directories"],
      "properties": {
        "allowed_directories": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 1,
          "description": "Directories that can be modified (glob patterns)"
        },
        "forbidden_paths": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Paths that must not be modified"
        }
      },
      "description": "Scope constraints for tool execution"
    },
    "steps": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["step_id", "goal", "constraints", "expected_artifacts"],
        "properties": {
          "step_id": {"type": "string"},
          "goal": {
            "type": "string",
            "description": "What needs to be accomplished"
          },
          "constraints": {
            "type": "object",
            "properties": {
              "must": {
                "type": "array",
                "items": {"type": "string"},
                "description": "Required constraints"
              },
              "must_not": {
                "type": "array",
                "items": {"type": "string"},
                "description": "Forbidden actions"
              }
            }
          },
          "expected_artifacts": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "type": {"type": "string", "enum": ["file", "directory", "commit"]},
                "path": {"type": "string"}
              }
            }
          },
          "verification_commands": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Commands to verify step completion (from allowlist)"
          }
        }
      },
      "minItems": 1,
      "description": "Ordered steps for the tool to execute"
    },
    "prompt_pack": {
      "type": "object",
      "required": ["system_prompt", "red_lines"],
      "properties": {
        "system_prompt": {
          "type": "string",
          "description": "Main instructions for the tool"
        },
        "red_lines": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Hard constraints that must not be violated"
        },
        "examples": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Example patterns or code"
        }
      },
      "description": "Prompts and constraints for the tool"
    },
    "acceptance": {
      "type": "object",
      "required": ["gates", "tests"],
      "properties": {
        "gates": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Gates that must pass"
        },
        "tests": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Test commands that must pass"
        },
        "policy_checks": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Policy verifications required"
        }
      },
      "description": "Acceptance criteria for tool output"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "priority": {"type": "string", "enum": ["low", "medium", "high"]},
        "estimated_complexity": {"type": "string", "enum": ["simple", "moderate", "complex"]},
        "timeout_minutes": {"type": "number", "minimum": 1}
      }
    }
  }
}
