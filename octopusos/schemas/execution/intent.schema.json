{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "agentos://schemas/execution/intent.schema.json",
  "title": "Execution Intent (v0.9.1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id",
    "type",
    "title",
    "version",
    "status",
    "created_at",
    "lineage",
    "scope",
    "objective",
    "selected_workflows",
    "selected_agents",
    "planned_commands",
    "interaction",
    "risk",
    "budgets",
    "evidence_refs",
    "constraints",
    "audit"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^intent_[a-z0-9_]{6,64}$"
    },
    "type": {
      "const": "execution_intent"
    },
    "title": {
      "type": "string",
      "minLength": 5,
      "maxLength": 160
    },
    "description": {
      "type": "string",
      "maxLength": 4000
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"
    },
    "status": {
      "type": "string",
      "enum": ["draft", "proposed", "approved", "rejected", "superseded"]
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },

    "lineage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["introduced_in", "derived_from", "supersedes"],
      "properties": {
        "introduced_in": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"
        },
        "derived_from": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^intent_[a-z0-9_]{6,64}$"
          },
          "maxItems": 16
        },
        "supersedes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^intent_[a-z0-9_]{6,64}$"
          },
          "maxItems": 16
        }
      }
    },

    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project_id", "repo_root", "targets"],
      "properties": {
        "project_id": { "type": "string", "minLength": 1, "maxLength": 128 },
        "repo_root": { "type": "string", "minLength": 1, "maxLength": 512 },
        "targets": {
          "type": "object",
          "additionalProperties": false,
          "required": ["files", "modules", "areas"],
          "properties": {
            "files": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 512 },
              "maxItems": 200
            },
            "modules": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 128 },
              "maxItems": 100
            },
            "areas": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["frontend", "backend", "infra", "docs", "tests", "ops", "security", "data"]
              },
              "maxItems": 8
            }
          }
        }
      }
    },

    "objective": {
      "type": "object",
      "additionalProperties": false,
      "required": ["goal", "success_criteria", "non_goals"],
      "properties": {
        "goal": { "type": "string", "minLength": 5, "maxLength": 2000 },
        "success_criteria": {
          "type": "array",
          "items": { "type": "string", "minLength": 3, "maxLength": 300 },
          "minItems": 1,
          "maxItems": 20
        },
        "non_goals": {
          "type": "array",
          "items": { "type": "string", "minLength": 3, "maxLength": 300 },
          "maxItems": 20
        }
      }
    },

    "selected_workflows": {
      "type": "array",
      "minItems": 1,
      "maxItems": 18,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["workflow_id", "phases"],
        "properties": {
          "workflow_id": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]{2,80}$"
          },
          "phases": {
            "type": "array",
            "minItems": 1,
            "maxItems": 12,
            "items": {
              "type": "string",
              "enum": [
                "setup",
                "analysis",
                "design",
                "implementation",
                "validation",
                "review",
                "release",
                "operations",
                "postmortem"
              ]
            }
          },
          "reason": {
            "type": "string",
            "minLength": 3,
            "maxLength": 800
          }
        }
      }
    },

    "selected_agents": {
      "type": "array",
      "minItems": 1,
      "maxItems": 13,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["agent_id", "role", "responsibilities"],
        "properties": {
          "agent_id": { "type": "string", "pattern": "^[a-z][a-z0-9_]{2,80}$" },
          "role": { "type": "string", "minLength": 2, "maxLength": 80 },
          "responsibilities": {
            "type": "array",
            "items": { "type": "string", "minLength": 3, "maxLength": 200 },
            "minItems": 1,
            "maxItems": 12
          }
        }
      }
    },

    "planned_commands": {
      "type": "array",
      "minItems": 0,
      "maxItems": 80,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["command_id", "intent", "effects", "risk_level", "evidence_refs"],
        "properties": {
          "command_id": { "type": "string", "pattern": "^[a-z][a-z0-9_]{2,120}$" },
          "intent": { "type": "string", "minLength": 3, "maxLength": 800 },
          "effects": {
            "type": "array",
            "items": { "type": "string", "enum": ["read", "write", "network", "deploy", "security", "data"] },
            "minItems": 1,
            "maxItems": 6
          },
          "risk_level": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
          "evidence_refs": {
            "type": "array",
            "items": { "type": "string", "minLength": 3, "maxLength": 256 },
            "minItems": 1,
            "maxItems": 30
          }
        }
      }
    },

    "interaction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "question_budget", "question_policy"],
      "properties": {
        "mode": { "type": "string", "enum": ["interactive", "semi_auto", "full_auto"] },
        "question_budget": { "type": "integer", "minimum": 0, "maximum": 50 },
        "question_policy": {
          "type": "string",
          "enum": ["conceptual_only", "blockers_only", "never"]
        }
      }
    },

    "risk": {
      "type": "object",
      "additionalProperties": false,
      "required": ["overall", "drivers", "requires_review"],
      "properties": {
        "overall": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
        "drivers": {
          "type": "array",
          "items": { "type": "string", "minLength": 3, "maxLength": 200 },
          "minItems": 1,
          "maxItems": 20
        },
        "requires_review": {
          "type": "array",
          "items": { "type": "string", "enum": ["security", "data", "release", "architecture", "cost", "compliance"] },
          "maxItems": 6
        }
      }
    },

    "budgets": {
      "type": "object",
      "additionalProperties": false,
      "required": ["max_files", "max_commits", "max_tokens", "max_cost_usd"],
      "properties": {
        "max_files": { "type": "integer", "minimum": 0, "maximum": 500 },
        "max_commits": { "type": "integer", "minimum": 0, "maximum": 50 },
        "max_tokens": { "type": "integer", "minimum": 0, "maximum": 2000000 },
        "max_cost_usd": { "type": "number", "minimum": 0, "maximum": 10000 }
      }
    },

    "evidence_refs": {
      "type": "array",
      "items": { "type": "string", "minLength": 3, "maxLength": 256 },
      "minItems": 1,
      "maxItems": 200
    },

    "constraints": {
      "type": "object",
      "additionalProperties": false,
      "required": ["execution", "no_fabrication", "registry_only", "lock_scope"],
      "properties": {
        "execution": { "const": "forbidden" },
        "no_fabrication": { "type": "boolean", "const": true },
        "registry_only": { "type": "boolean", "const": true },
        "lock_scope": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mode", "paths"],
          "properties": {
            "mode": { "type": "string", "enum": ["none", "task", "files"] },
            "paths": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 512 },
              "maxItems": 200
            }
          }
        }
      }
    },

    "audit": {
      "type": "object",
      "additionalProperties": false,
      "required": ["created_by", "source", "checksum"],
      "properties": {
        "created_by": { "type": "string", "minLength": 1, "maxLength": 128 },
        "source": { "type": "string", "enum": ["human", "agentos", "imported"] },
        "checksum": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      }
    }
  },

  "allOf": [
    {
      "$comment": "Invariant: full_auto => question_budget=0 and question_policy=never",
      "if": {
        "properties": { "interaction": { "properties": { "mode": { "const": "full_auto" } } } }
      },
      "then": {
        "properties": {
          "interaction": {
            "properties": {
              "question_budget": { "const": 0 },
              "question_policy": { "const": "never" }
            }
          }
        }
      }
    },
    {
      "$comment": "Invariant: high/critical risk => not full_auto",
      "if": {
        "properties": { "risk": { "properties": { "overall": { "enum": ["high", "critical"] } } } }
      },
      "then": {
        "properties": { "interaction": { "properties": { "mode": { "enum": ["interactive", "semi_auto"] } } } }
      }
    },
    {
      "$comment": "Invariant: any planned command with write/deploy => requires_review must include release or operations",
      "if": {
        "properties": {
          "planned_commands": {
            "contains": {
              "properties": {
                "effects": { "contains": { "enum": ["write", "deploy"] } }
              },
              "required": ["effects"]
            }
          }
        }
      },
      "then": {
        "properties": {
          "risk": {
            "properties": {
              "requires_review": {
                "contains": { "enum": ["release", "architecture", "security", "compliance", "cost", "data"] }
              }
            }
          }
        }
      }
    }
  ]
}
