{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "agentos://schemas/execution/intent_builder_output.schema.json",
  "title": "Intent Builder Output (v0.9.4)",
  "description": "Output from Intent Builder: ExecutionIntent + QuestionPack + Evidence",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id",
    "schema_version",
    "nl_request_id",
    "execution_intent",
    "selection_evidence",
    "builder_audit",
    "lineage"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^builder_out_[a-z0-9_]{6,64}$",
      "description": "Unique identifier for this builder output"
    },
    "schema_version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
      "const": "0.9.4",
      "description": "Schema version"
    },
    "nl_request_id": {
      "type": "string",
      "pattern": "^nl_req_[a-z0-9_]{6,64}$",
      "description": "Reference to the source NL request"
    },
    "execution_intent": {
      "$ref": "agentos://schemas/execution/intent.schema.json",
      "description": "Generated ExecutionIntent (v0.9.1)"
    },
    "question_pack": {
      "type": ["object", "null"],
      "description": "Generated questions for interactive/semi_auto modes",
      "additionalProperties": false,
      "required": ["questions", "budget_used", "policy"],
      "properties": {
        "questions": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "question_id",
              "type",
              "blocking_level",
              "question_text",
              "context",
              "evidence_refs"
            ],
            "properties": {
              "question_id": {
                "type": "string",
                "pattern": "^q_[a-z0-9_]{4,32}$"
              },
              "type": {
                "type": "string",
                "enum": ["clarification", "blocker", "optimization", "risk_mitigation"]
              },
              "blocking_level": {
                "type": "string",
                "enum": ["critical", "high", "medium", "low"]
              },
              "question_text": {
                "type": "string",
                "minLength": 10,
                "maxLength": 2000
              },
              "context": {
                "type": "string",
                "minLength": 10,
                "maxLength": 4000
              },
              "evidence_refs": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 512
                },
                "minItems": 1
              },
              "default_strategy": {
                "type": "string",
                "maxLength": 1000
              },
              "suggested_answers": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["answer_text", "rationale"],
                  "properties": {
                    "answer_text": {
                      "type": "string",
                      "maxLength": 1000
                    },
                    "rationale": {
                      "type": "string",
                      "maxLength": 1000
                    }
                  }
                }
              }
            }
          },
          "maxItems": 50
        },
        "budget_used": {
          "type": "integer",
          "minimum": 0,
          "maximum": 50,
          "description": "Number of questions generated"
        },
        "policy": {
          "type": "string",
          "enum": ["conceptual_only", "blockers_only", "never"],
          "description": "Question policy applied"
        }
      }
    },
    "selection_evidence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["workflow_selections", "agent_selections", "command_selections"],
      "description": "Evidence for each selection made",
      "properties": {
        "workflow_selections": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["workflow_id", "reason", "evidence_refs"],
            "properties": {
              "workflow_id": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9_]{2,80}$"
              },
              "reason": {
                "type": "string",
                "minLength": 10,
                "maxLength": 1000
              },
              "evidence_refs": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 3,
                  "maxLength": 512
                },
                "minItems": 1,
                "maxItems": 30,
                "description": "Evidence refs: nl_input:x:y, registry:id:ver, rule:id"
              }
            }
          },
          "maxItems": 18
        },
        "agent_selections": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["agent_id", "role", "reason", "evidence_refs"],
            "properties": {
              "agent_id": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9_]{2,80}$"
              },
              "role": {
                "type": "string",
                "minLength": 2,
                "maxLength": 80
              },
              "reason": {
                "type": "string",
                "minLength": 10,
                "maxLength": 1000
              },
              "evidence_refs": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 3,
                  "maxLength": 512
                },
                "minItems": 1,
                "maxItems": 30
              }
            }
          },
          "maxItems": 13
        },
        "command_selections": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["command_id", "reason", "evidence_refs"],
            "properties": {
              "command_id": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9_]{2,120}$"
              },
              "reason": {
                "type": "string",
                "minLength": 10,
                "maxLength": 1000
              },
              "evidence_refs": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 3,
                  "maxLength": 512
                },
                "minItems": 1,
                "maxItems": 30
              }
            }
          },
          "maxItems": 80
        }
      }
    },
    "builder_audit": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "builder_version",
        "model_used",
        "policy_applied",
        "adjudication_summary",
        "created_at",
        "checksum"
      ],
      "properties": {
        "builder_version": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
          "description": "Builder version"
        },
        "model_used": {
          "type": "string",
          "minLength": 3,
          "maxLength": 128,
          "description": "Model used: rule_based or model name"
        },
        "policy_applied": {
          "type": "string",
          "enum": ["full_auto", "semi_auto", "interactive"],
          "description": "Execution policy applied"
        },
        "adjudication_summary": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "risk_level": {
              "type": "string",
              "enum": ["low", "medium", "high", "critical"]
            },
            "ambiguities_detected": {
              "type": "integer",
              "minimum": 0
            },
            "registry_queries": {
              "type": "integer",
              "minimum": 0
            },
            "decisions_made": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "checksum": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 checksum of the output"
        }
      }
    },
    "lineage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["introduced_in", "derived_from", "supersedes"],
      "properties": {
        "introduced_in": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"
        },
        "derived_from": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^(nl_req_|builder_out_)[a-z0-9_]{6,64}$"
          },
          "maxItems": 16
        },
        "supersedes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^builder_out_[a-z0-9_]{6,64}$"
          },
          "maxItems": 16
        }
      }
    }
  },
  "allOf": [
    {
      "$comment": "RED LINE: full_auto mode => question_pack must be null or empty",
      "if": {
        "properties": {
          "builder_audit": {
            "properties": {
              "policy_applied": {
                "const": "full_auto"
              }
            }
          }
        }
      },
      "then": {
        "anyOf": [
          {
            "properties": {
              "question_pack": {
                "type": "null"
              }
            }
          },
          {
            "properties": {
              "question_pack": {
                "properties": {
                  "questions": {
                    "maxItems": 0
                  },
                  "budget_used": {
                    "const": 0
                  }
                }
              }
            }
          }
        ]
      }
    },
    {
      "$comment": "RED LINE: Every selection must have at least one evidence_ref",
      "properties": {
        "selection_evidence": {
          "properties": {
            "workflow_selections": {
              "items": {
                "properties": {
                  "evidence_refs": {
                    "minItems": 1
                  }
                }
              }
            },
            "agent_selections": {
              "items": {
                "properties": {
                  "evidence_refs": {
                    "minItems": 1
                  }
                }
              }
            },
            "command_selections": {
              "items": {
                "properties": {
                  "evidence_refs": {
                    "minItems": 1
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}
