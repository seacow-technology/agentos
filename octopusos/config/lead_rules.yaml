# Lead Agent 规则阈值配置
#
# 版本: 1.0.0
# 最后更新: 2025-01-28
#
# 说明:
# - 这些是默认阈值，已经过生产验证
# - 可通过环境变量 LEAD_CONFIG 或命令行参数 override
# - 修改后需重启 lead_scan job

version: "1.0.0"

# 规则阈值配置
rules:
  # 规则1: blocked_reason_spike - 相同错误码激增检测
  blocked_reason_spike:
    threshold: 5  # 24h 内相同 code 出现次数超过此值触发
    description: "检测相同错误码在短时间内大量出现"
    severity: "HIGH"

  # 规则2: pause_block_churn - PAUSE 后 BLOCK 模式检测
  pause_block_churn:
    pause_count_threshold: 2  # PAUSE 次数阈值
    description: "检测任务多次暂停后最终被阻塞"
    severity: "MEDIUM"

  # 规则3: retry_recommended_but_fails - RETRY 后仍失败
  retry_then_fail:
    threshold: 1  # 至少1次 RETRY 后失败即触发
    description: "检测建议重试但仍然失败的任务"
    severity: "HIGH"

  # 规则4: decision_lag_anomaly - 决策延迟异常
  decision_lag:
    p95_threshold_ms: 5000  # p95 延迟超过此值（毫秒）触发
    description: "检测 Supervisor 决策延迟异常"
    severity: "MEDIUM"

  # 规则5: redline_ratio_increase - REDLINE 占比上升
  redline_ratio:
    increase_threshold: 0.10  # 占比增幅超过 10% 触发
    min_baseline: 0.05  # 基准占比至少 5%（避免噪音）
    description: "检测高风险 findings 占比显著上升"
    severity: "HIGH"

  # 规则6: high_risk_allow - 高危问题被放行
  high_risk_allow:
    threshold: 1  # 任何 HIGH/CRITICAL 被 ALLOW 即触发
    description: "检测高风险或严重风险被允许通过"
    severity: "CRITICAL"

# 窗口配置
windows:
  "24h":
    description: "24小时滚动窗口"
    default_schedule: "0 2 * * *"  # 每天凌晨2点
  "7d":
    description: "7天滚动窗口"
    default_schedule: "0 3 * * 1"  # 每周一凌晨3点

# 告警阈值（P0-2 自检）
alert_thresholds:
  min_blocked_for_alert: 5  # blocked 数量超过此值且 findings=0 时告警
  min_high_risk_for_alert: 1  # high_risk_allow 数量超过此值且 findings=0 时告警

# 日志配置
logging:
  print_threshold_summary: true  # 扫描开始时打印阈值摘要
  log_level: "INFO"
