# Phase 4 高级功能测试指南

## ✅ 全部实施完成

**实施时间**: 2026-01-28
**版本**: v25
**提交**: 21261da

---

## 🎯 实施功能清单

### Phase 4 - 全部完成 ✅
1. ✅ **主题切换** - 6 种 Prism 主题
2. ✅ **预览历史** - LocalStorage 追踪（最多 10 项）
3. ✅ **实时代码编辑** - 分屏编辑器 + 实时预览
4. ✅ **多文件支持** - HTML/CSS/JS 分离 + Tab 切换
5. ✅ **分享链接** - 后端 API + 前端集成

---

## 🧪 功能测试

### 测试 1: 主题切换功能

**步骤**:
1. 在 Chat 页面发送：`"写一个 JavaScript 函数"`
2. AI 回复后，找到代码块
3. 点击代码块头部的 **主题选择器下拉菜单**
4. 选择不同主题

**验证点**:
- [ ] 下拉菜单显示 6 个主题选项：
  - Tomorrow Night（默认）
  - Okaidia
  - Dracula
  - One Dark
  - Solarized Dark
  - Monokai
- [ ] 切换主题后，代码块颜色立即改变
- [ ] 所有代码块同时切换主题
- [ ] 刷新页面后，主题保持选择状态（localStorage）
- [ ] 语法高亮在所有主题下正常工作

---

### 测试 2: 预览历史功能

**步骤**:
1. 在 Chat 页面发送：`"创建 3 个不同的 HTML 页面"`
2. 分别预览每个 HTML 页面（点击 Preview 按钮）
3. 在 Preview Dialog 中点击 **"History" 按钮**
4. 查看历史记录侧边栏

**验证点**:
- [ ] History 侧边栏从右侧滑出（宽度 350px）
- [ ] 显示最近预览的 HTML（最新的在最上面）
- [ ] 每个历史项显示：
  - 标题（从 <title> 或 <h1> 提取）
  - 时间戳（完整日期时间）
  - 代码预览（前 100 字符）
  - 删除按钮（红色 X）
- [ ] 点击历史项重新打开预览
- [ ] 点击单个删除按钮删除该项
- [ ] 点击 "Clear All" 清空所有历史
- [ ] 最多保存 10 个历史项（超过自动删除最旧的）
- [ ] 刷新页面后历史仍然保留（localStorage）
- [ ] 点击 X 按钮关闭侧边栏

---

### 测试 3: 实时代码编辑功能

**步骤**:
1. 创建一个 HTML 页面并预览
2. 在 Preview Dialog 中点击 **"Edit" 按钮**
3. 查看编辑器面板

**验证点**:
- [ ] 编辑器面板从左侧出现（占 50% 宽度）
- [ ] 预览区域缩小到右侧 50%
- [ ] 显示 3 个 Tab: HTML, CSS, JS
- [ ] HTML tab 默认激活
- [ ] HTML 编辑器显示提取的 HTML 内容（无 head/style/script）
- [ ] CSS 编辑器显示提取的 CSS 内容（来自 <style>）
- [ ] JS 编辑器显示提取的 JS 内容（来自 <script>）
- [ ] 编辑器使用等宽字体（Mono）
- [ ] 编辑器背景为深色（#1e1e1e）
- [ ] 底部显示 "Apply Changes" 和 "Reset" 按钮
- [ ] 再次点击 "Edit" 按钮关闭编辑器

---

### 测试 4: 多文件编辑功能

**步骤**:
1. 打开编辑模式（Edit 按钮）
2. 在 HTML tab 中修改 HTML 内容
3. 切换到 CSS tab
4. 添加新的 CSS 规则
5. 切换到 JS tab
6. 添加 JavaScript 代码
7. 点击 **"Apply Changes" 按钮**

**验证点**:
- [ ] 切换 Tab 时显示对应的编辑器
- [ ] 只有激活的 Tab 按钮高亮
- [ ] 修改内容不会自动应用
- [ ] 点击 "Apply Changes" 后：
  - 预览立即更新
  - HTML/CSS/JS 正确组合
  - CSS 注入到 <style>
  - JS 注入到 <script>
- [ ] 点击 "Reset" 按钮：
  - 编辑器恢复到原始代码
  - 预览恢复到原始状态

---

### 测试 5: 分享链接功能

**步骤**:
1. 创建一个 HTML 页面并预览
2. 在 Preview Dialog 中点击 **"Share" 按钮**
3. 查看浏览器提示
4. 打开新浏览器标签页（或无痕模式）
5. 粘贴分享链接并访问

**验证点**:
- [ ] 点击 Share 后显示 "Share link copied to clipboard" 提示
- [ ] 提示显示完整的分享 URL
- [ ] 分享链接格式: `http://127.0.0.1:8080/share/{8位ID}`
- [ ] 分享页面加载正常
- [ ] 显示 "Shared" 徽章和分享 ID
- [ ] HTML 内容完整显示
- [ ] 交互功能正常（按钮、表单等）
- [ ] 不存在的分享 ID 显示 "Preview Not Found"
- [ ] 分享链接在 30 天后过期

---

### 测试 6: 组合功能测试

**场景**: 创建、编辑、分享一个复杂 HTML

**步骤**:
1. 发送：`"创建一个登录表单，包含 CSS 样式和表单验证 JS"`
2. 预览 HTML
3. 切换不同主题查看效果
4. 进入编辑模式
5. 修改 CSS 颜色
6. 修改 JS 验证逻辑
7. 应用更改
8. 分享修改后的预览
9. 在新标签页打开分享链接
10. 查看历史记录

**验证点**:
- [ ] 所有功能同时工作无冲突
- [ ] 主题切换不影响编辑模式
- [ ] 编辑后的代码可以正常分享
- [ ] 分享的是编辑后的版本（不是原始版本）
- [ ] 历史记录保存编辑后的版本
- [ ] 从历史重新打开可以再次编辑

---

### 测试 7: 后端 API 测试

**使用 curl 或 Postman 测试**:

#### 创建分享
```bash
curl -X POST http://127.0.0.1:8080/api/share \
  -H "Content-Type: application/json" \
  -d '{"code": "<html><body><h1>Test</h1></body></html>"}'
```

**验证点**:
- [ ] 返回 200 状态码
- [ ] 返回 JSON: `{id, url, expires_at}`
- [ ] ID 长度为 8 字符
- [ ] expires_at 为 30 天后

#### 获取分享
```bash
curl http://127.0.0.1:8080/api/share/{id}
```

**验证点**:
- [ ] 返回 200 状态码
- [ ] 返回 JSON: `{id, code, created_at, expires_at}`
- [ ] code 字段包含完整 HTML

#### 获取统计
```bash
curl http://127.0.0.1:8080/api/shares/stats
```

**验证点**:
- [ ] 返回 200 状态码
- [ ] 返回 JSON: `{total_shares, max_shares, expiry_days}`

---

## 📊 UI/UX 验证

### 主题切换
- [ ] 下拉菜单样式美观
- [ ] 主题切换流畅无闪烁
- [ ] 选中主题高亮显示
- [ ] Hover 效果正常

### 编辑器
- [ ] Tab 切换流畅
- [ ] 编辑器字体大小合适（13px）
- [ ] 行号对齐（如果添加）
- [ ] 滚动条样式统一
- [ ] 按钮位置合理
- [ ] 按钮颜色区分明显

### 历史侧边栏
- [ ] 滑出动画流畅
- [ ] 列表滚动流畅
- [ ] 项目悬浮效果明显
- [ ] 删除按钮颜色醒目（红色）
- [ ] 时间戳格式清晰
- [ ] 空状态提示友好

### 分享页面
- [ ] 加载动画显示正确
- [ ] 错误状态显示友好
- [ ] Header 样式一致
- [ ] Shared 徽章醒目

---

## 🔧 性能测试

### 主题切换
- [ ] 切换响应时间 < 200ms
- [ ] 无明显卡顿
- [ ] 多次切换性能稳定

### 编辑器
- [ ] Tab 切换响应时间 < 50ms
- [ ] Apply Changes 响应时间 < 300ms
- [ ] 大文件（> 1000 行）编辑流畅

### 历史记录
- [ ] 打开侧边栏 < 100ms
- [ ] 加载历史 < 50ms
- [ ] 滚动流畅无延迟

### 分享功能
- [ ] 创建分享 API 响应 < 500ms
- [ ] 打开分享页面 < 1s
- [ ] 加载 HTML 内容 < 500ms

---

## 🐛 边界情况测试

### 主题切换
1. **快速连续切换主题**:
   - [ ] 不会导致错误
   - [ ] 最终主题正确
   - [ ] localStorage 正确保存

2. **页面刷新后主题**:
   - [ ] 保持用户选择
   - [ ] 新代码块使用相同主题

### 编辑器
1. **空内容编辑**:
   - [ ] HTML 为空时正常工作
   - [ ] CSS 为空时正常工作
   - [ ] JS 为空时正常工作

2. **超长代码**:
   - [ ] > 10,000 行代码正常编辑
   - [ ] 滚动流畅
   - [ ] Apply Changes 正常

3. **特殊字符**:
   - [ ] `<`, `>`, `&`, `"`, `'` 正确处理
   - [ ] Unicode 字符正常显示
   - [ ] Emoji 正常显示

### 历史记录
1. **超过 10 项**:
   - [ ] 自动删除最旧项
   - [ ] 总数保持 10

2. **LocalStorage 满**:
   - [ ] 优雅降级
   - [ ] 显示错误提示

3. **损坏的数据**:
   - [ ] 不会崩溃
   - [ ] 清空并重新开始

### 分享功能
1. **重复分享**:
   - [ ] 每次生成新 ID
   - [ ] 不会覆盖旧分享

2. **超过最大数量**（1000）:
   - [ ] 自动删除最旧分享
   - [ ] 新分享正常创建

3. **过期分享**:
   - [ ] 自动清理
   - [ ] 访问时显示友好错误

---

## ✅ 验收清单

### 功能完整性
- [ ] 主题切换完全工作（6 个主题）
- [ ] 预览历史完全工作（增删查）
- [ ] 实时编辑完全工作（编辑+预览）
- [ ] 多文件支持完全工作（HTML/CSS/JS）
- [ ] 分享链接完全工作（创建+访问）

### UI/UX 质量
- [ ] 所有新按钮样式一致
- [ ] 动画流畅无卡顿
- [ ] 颜色搭配协调
- [ ] 图标清晰可见
- [ ] 响应式设计良好

### 性能要求
- [ ] 所有操作响应时间 < 500ms
- [ ] 无内存泄漏
- [ ] 大文件编辑流畅
- [ ] 多次操作性能稳定

### 兼容性
- [ ] Chrome/Edge 正常工作
- [ ] Firefox 正常工作
- [ ] Safari 正常工作（如可用）

### 安全性
- [ ] 分享的 HTML 使用 sandbox
- [ ] 不执行恶意代码
- [ ] LocalStorage 数据验证
- [ ] API 输入验证

---

## 📝 已知限制

### 主题切换
- 主题列表硬编码（可扩展）
- 不支持自定义主题

### 编辑器
- 无语法高亮（纯文本）
- 无代码补全
- 无错误检查
- 建议：未来集成 CodeMirror 或 Monaco Editor

### 历史记录
- 仅存储在 LocalStorage（非云同步）
- 最多 10 项（可配置）
- 无搜索功能
- 无标签/分类

### 分享功能
- 存储在内存（重启丢失）
- 建议：迁移到 SQLite/PostgreSQL
- 无访问统计
- 无隐私控制（所有分享公开）
- 无分享管理界面

---

## 🚀 未来增强

### 短期（Sprint）
1. 将分享存储迁移到数据库
2. 添加编辑器语法高亮（CodeMirror）
3. 添加历史记录搜索
4. 添加分享访问计数

### 中期（Release）
1. 添加云同步历史记录
2. 集成 Monaco Editor（完整 IDE）
3. 添加分享隐私选项（public/unlisted/private）
4. 添加分享管理页面
5. 添加代码版本控制

### 长期（Roadmap）
1. 多用户协作编辑
2. 代码片段库
3. 模板系统
4. AI 辅助编辑
5. 部署到静态托管

---

## 🎉 实施总结

### 完成功能
**Phase 4 - 全部完成**:
1. ✅ 主题切换 - 6 种主题 + localStorage 持久化
2. ✅ 预览历史 - 10 项历史 + CRUD 操作
3. ✅ 实时编辑 - 分屏编辑器 + 实时预览
4. ✅ 多文件支持 - HTML/CSS/JS 分离 + Tab 切换
5. ✅ 分享链接 - REST API + 前端集成 + 分享页面

### 代码统计
- **前端代码**: ~1500 行新增代码
  - main.js: ~800 行
  - components.css: ~500 行
  - codeblocks.js: ~50 行
  - index.html: ~150 行

- **后端代码**: ~200 行新增代码
  - share.py: ~200 行（API 路由）
  - app.py: ~15 行（路由注册）
  - share.html: ~150 行（分享页面）

- **总计**: ~1850 行新增代码

### 技术栈
- **前端**: Vanilla JS, CSS Grid, Flexbox
- **后端**: FastAPI, Pydantic, Python 3.13
- **存储**: LocalStorage (前端), In-memory Dict (后端)
- **主题**: Prism.js + 6 个主题
- **API**: RESTful JSON

### 测试覆盖
- 功能测试: 7 个场景
- 边界测试: 12 个场景
- 性能测试: 4 个指标
- 兼容性测试: 3 个浏览器

---

**实施完成**: 2026-01-28
**提交哈希**: 21261da
**状态**: ✅ 准备测试
**版本**: v25

**快速测试**：
```bash
# 1. 访问 Chat 页面
http://127.0.0.1:8080

# 2. 发送测试消息
"创建一个 HTML 登录表单，包含 CSS 和 JS 验证"

# 3. 测试所有新功能
- 切换主题
- 预览并编辑
- 分享链接
- 查看历史
```
