......................FFFF.FFFFFFF........................F............. [  7%]
.....F.......F.F........................................................ [ 14%]
..........FF.F...........F.............................................. [ 21%]
........................................................................ [ 29%]
............F........FF....F.F.......................................... [ 36%]
...................................................FF................... [ 43%]
........................................................................ [ 51%]
..........................................................F......FFF.FFF [ 58%]
FF..F.................................................F......F.......... [ 65%]
......................................................................FF [ 73%]
..FF.FFFF..F.F.FFF.FFF.................................................. [ 80%]
..............F............................................F....F....... [ 87%]
........F.....FF.F...FF..............................................F.. [ 95%]
FFFFFFFFF...F.................................                           [100%]
=================================== FAILURES ===================================
_______________ TestTaskHandler.test_task_handler_creates_draft ________________

self = <test_task_handler.TestTaskHandler object at 0x1099302d0>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_task_handler_creates_draf0/test_handler.db')

    def test_task_handler_creates_draft(self, temp_db):
        """Test that /task handler creates DRAFT task"""
        # Create chat session first
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        # Build context
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        # Execute command
        result = task_handler(
            command="task",
            args=["Test", "Task", "Title"],
            context=context
        )
    
        # Verify success
>       assert result.success is True
E       AssertionError: assert False is True
E        +  where False = CommandResult(success=False, message='Failed to create task: FOREIGN KEY constraint failed', data=None, should_display=True).success

tests/unit/chat/test_task_handler.py:137: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
___________ TestTaskHandler.test_handler_provides_approval_guidance ____________

self = <test_task_handler.TestTaskHandler object at 0x109930410>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_provides_approval0/test_handler.db')

    def test_handler_provides_approval_guidance(self, temp_db):
        """Test that handler provides clear approval guidance"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Test", "Task"],
            context=context
        )
    
        # Verify message includes approval guidance
        message = result.message
>       assert "DRAFT" in message
E       AssertionError: assert 'DRAFT' in 'Failed to create task: FOREIGN KEY constraint failed'

tests/unit/chat/test_task_handler.py:166: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
__________ TestTaskHandler.test_handler_includes_task_id_in_response ___________

self = <test_task_handler.TestTaskHandler object at 0x109827a80>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_includes_task_id_0/test_handler.db')

    def test_handler_includes_task_id_in_response(self, temp_db):
        """Test that handler includes task ID in response"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["My", "Task"],
            context=context
        )
    
        # Verify task ID is in data and message
>       assert "task_id" in result.data
               ^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: argument of type 'NoneType' is not iterable

tests/unit/chat/test_task_handler.py:188: TypeError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
___________ TestTaskHandler.test_handler_sets_next_action_to_approve ___________

self = <test_task_handler.TestTaskHandler object at 0x109827bb0>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_sets_next_action_0/test_handler.db')

    def test_handler_sets_next_action_to_approve(self, temp_db):
        """Test that handler sets next_action to 'approve'"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Test"],
            context=context
        )
    
        # Verify next_action is set
>       assert result.data["next_action"] == "approve"
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/unit/chat/test_task_handler.py:209: TypeError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_________ TestTaskHandler.test_handler_with_no_args_uses_default_title _________

self = <test_task_handler.TestTaskHandler object at 0x10988acf0>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_with_no_args_uses0/test_handler.db')

    def test_handler_with_no_args_uses_default_title(self, temp_db):
        """Test that handler uses default title when no args provided"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="My Chat Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=[],
            context=context
        )
    
        # Verify success and check title
>       assert result.success is True
E       AssertionError: assert False is True
E        +  where False = CommandResult(success=False, message='Failed to create task: FOREIGN KEY constraint failed', data=None, should_display=True).success

tests/unit/chat/test_task_handler.py:242: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
______________ TestTaskHandler.test_handler_creates_lineage_entry ______________

self = <test_task_handler.TestTaskHandler object at 0x10988ae00>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_creates_lineage_e0/test_handler.db')

    def test_handler_creates_lineage_entry(self, temp_db):
        """Test that handler creates lineage entry"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Test"],
            context=context
        )
    
        # Verify lineage entry was created
>       task_id = result.data["task_id"]
                  ^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/unit/chat/test_task_handler.py:263: TypeError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
__________ TestTaskHandler.test_handler_updates_chat_session_metadata __________

self = <test_task_handler.TestTaskHandler object at 0x109829950>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_updates_chat_sess0/test_handler.db')

    def test_handler_updates_chat_session_metadata(self, temp_db):
        """Test that handler updates chat session metadata"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Test"],
            context=context
        )
    
        # Verify chat session metadata was updated
>       task_id = result.data["task_id"]
                  ^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/unit/chat/test_task_handler.py:290: TypeError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_________________ TestTaskHandler.test_handler_message_format __________________

self = <test_task_handler.TestTaskHandler object at 0x10982b750>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_message_format0/test_handler.db')

    def test_handler_message_format(self, temp_db):
        """Test that handler message has proper format"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Format", "Test"],
            context=context
        )
    
        message = result.message
    
        # Verify message structure
>       assert "✓" in message or "Created" in message  # Success indicator
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert ('✓' in 'Failed to create task: FOREIGN KEY constraint failed' or 'Created' in 'Failed to create task: FOREIGN KEY constraint failed')

tests/unit/chat/test_task_handler.py:313: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
___________ TestTaskHandler.test_handler_routing_result_in_response ____________

self = <test_task_handler.TestTaskHandler object at 0x1097de120>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_handler_routing_result_in0/test_handler.db')

    def test_handler_routing_result_in_response(self, temp_db):
        """Test that routing result is included (if available)"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Test Session")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Routing", "Test"],
            context=context
        )
    
        # Routing may succeed or fail, but should be in data
>       assert "routing" in result.data
               ^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: argument of type 'NoneType' is not iterable

tests/unit/chat/test_task_handler.py:337: TypeError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_________ TestTaskHandlerIntegration.test_create_and_approve_workflow __________

self = <test_task_handler.TestTaskHandlerIntegration object at 0x109930550>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_create_and_approve_workfl0/test_handler.db')

    def test_create_and_approve_workflow(self, temp_db):
        """Test complete workflow: create via handler, then approve"""
        # Step 1: Create via handler
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Integration Test")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        result = task_handler(
            command="task",
            args=["Integration", "Test"],
            context=context
        )
    
>       assert result.success is True
E       AssertionError: assert False is True
E        +  where False = CommandResult(success=False, message='Failed to create task: FOREIGN KEY constraint failed', data=None, should_display=True).success

tests/unit/chat/test_task_handler.py:360: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_______ TestTaskHandlerIntegration.test_multiple_tasks_from_same_session _______

self = <test_task_handler.TestTaskHandlerIntegration object at 0x109930690>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_multiple_tasks_from_same_0/test_handler.db')

    def test_multiple_tasks_from_same_session(self, temp_db):
        """Test creating multiple tasks from same chat session"""
        chat_service = ChatService(db_path=temp_db)
        session = chat_service.create_session(title="Multi Task Test")
    
        context = {
            "session_id": session.session_id,
            "chat_service": chat_service,
        }
    
        # Create multiple tasks
        task_ids = []
        for i in range(3):
            result = task_handler(
                command="task",
                args=[f"Task {i}"],
                context=context
            )
>           assert result.success is True
E           AssertionError: assert False is True
E            +  where False = CommandResult(success=False, message='Failed to create task: FOREIGN KEY constraint failed', data=None, should_display=True).success

tests/unit/chat/test_task_handler.py:401: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.chat.handlers.task_handler:task_handler.py:180 Task command failed: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/handlers/task_handler.py", line 51, in task_handler
    result = workflow.create_draft_from_chat(
        title=title,
    ...<2 lines>...
        metadata={"chat_command": "/task"}
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/chat/workflow.py", line 81, in create_draft_from_chat
    task = self.task_service.create_draft_task(
        title=title,
    ...<2 lines>...
        metadata=metadata
    )
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 155, in create_draft_task
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<19 lines>...
        ),
        ^^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
____________ TestImportCommand.test_import_project_from_cli_options ____________

self = <cli.test_project.TestImportCommand object at 0x10a494e10>
mock_validate_auth = <MagicMock name='validate_auth_profiles' id='4497296416'>
mock_get_db = <MagicMock name='get_db' id='4497301456'>
mock_get_db_path = <MagicMock name='get_db_path' id='4497307504'>
temp_db = PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmpzv4b48ox/test.db')

    @patch("agentos.cli.project.get_db_path")
    @patch("agentos.cli.project.get_db")
    @patch("agentos.cli.project.validate_auth_profiles")
    def test_import_project_from_cli_options(
        self, mock_validate_auth, mock_get_db, mock_get_db_path, temp_db
    ):
        """Test importing project with CLI options"""
        # Setup mocks
        mock_get_db_path.return_value = temp_db
        mock_validate_auth.return_value = (True, [])
    
        # Mock database connection
        conn = sqlite3.connect(str(temp_db))
        conn.row_factory = sqlite3.Row
        conn.execute("PRAGMA foreign_keys = ON")
        mock_get_db.return_value = conn
    
        # Run command
        runner = CliRunner()
        result = runner.invoke(
            import_project,
            [
                "test-project",
                "--repo",
                "name=backend,path=./be,role=code",
                "--repo",
                "name=frontend,path=./fe,role=code",
                "--yes",
            ],
        )
    
        # Check result
>       assert result.exit_code == 0
E       assert 1 == 0
E        +  where 1 = <Result SystemExit(1)>.exit_code

tests/unit/cli/test_project.py:449: AssertionError
________________ TestProjectTraceCommand.test_project_not_found ________________

self = <cli.test_project_trace.TestProjectTraceCommand object at 0x10a4c08a0>
mock_get_db = <MagicMock name='get_db' id='4497727440'>
runner = <click.testing.CliRunner object at 0x10c186950>

    @patch("agentos.cli.commands.project_trace.get_db")
    def test_project_not_found(self, mock_get_db, runner):
        """Test error when project not found"""
        mock_db = Mock()
        mock_get_db.return_value = mock_db
    
        cursor_mock = Mock()
        cursor_mock.fetchone.return_value = None
        mock_db.execute.return_value = cursor_mock
    
        result = runner.invoke(project_trace, ["nonexistent-project"])
    
        assert result.exit_code == 1
>       assert "not found" in result.output.lower()
E       assert 'not found' in ''
E        +  where '' = <built-in method lower of str object at 0x103243318>()
E        +    where <built-in method lower of str object at 0x103243318> = ''.lower
E        +      where '' = <Result TypeError("Console.print() got an unexpected keyword argument 'err'")>.output

tests/unit/cli/test_project_trace.py:343: AssertionError
______________ TestTaskTraceCommand.test_task_trace_table_format _______________

self = <cli.test_task_trace.TestTaskTraceCommand object at 0x10a496e90>
mock_dep_service = <MagicMock name='TaskDependencyService' id='4497733488'>
mock_artifact_service = <MagicMock name='TaskArtifactService' id='4497733824'>
mock_audit_service = <MagicMock name='TaskAuditService' id='4497734160'>
mock_repo_crud = <MagicMock name='ProjectRepository' id='4497734496'>
mock_get_db_path = <MagicMock name='get_db_path' id='4497734832'>
mock_get_db = <MagicMock name='get_db' id='4497735168'>
runner = <click.testing.CliRunner object at 0x10c1575c0>

    @patch("agentos.cli.commands.task_trace.get_db")
    @patch("agentos.cli.commands.task_trace.get_db_path")
    @patch("agentos.cli.commands.task_trace.ProjectRepository")
    @patch("agentos.cli.commands.task_trace.TaskAuditService")
    @patch("agentos.cli.commands.task_trace.TaskArtifactService")
    @patch("agentos.cli.commands.task_trace.TaskDependencyService")
    def test_task_trace_table_format(
        self,
        mock_dep_service,
        mock_artifact_service,
        mock_audit_service,
        mock_repo_crud,
        mock_get_db_path,
        mock_get_db,
        runner,
    ):
        """Test table format output"""
        # Setup mocks
        mock_db = Mock()
        mock_get_db.return_value = mock_db
        mock_get_db_path.return_value = Path("/tmp/test.db")
    
        # Mock task info query
        cursor_mock = Mock()
        cursor_mock.fetchone.side_effect = [
            # First call: task basic info
            {
                "task_id": "task-001",
                "status": "completed",
                "created_at": "2026-01-28T10:00:00Z",
                "updated_at": "2026-01-28T11:00:00Z",
            },
            # Second call: repo scopes query
            {"repo_id": "repo-001", "access_scope": "FULL"},
            # Third call: repo name lookup
            {"name": "backend", "remote_url": "git@github.com:org/backend"},
        ]
    
        cursor_mock.fetchall.return_value = [
            {"repo_id": "repo-001", "access_scope": "FULL"}
        ]
    
        mock_db.execute.return_value = cursor_mock
    
        # Mock audit service
        mock_audit_instance = Mock()
        mock_audit_instance.get_task_audits.return_value = []
        mock_audit_service.return_value = mock_audit_instance
    
        # Mock artifact service
        mock_artifact_instance = Mock()
        mock_artifact_instance.get_task_artifacts.return_value = []
        mock_artifact_service.return_value = mock_artifact_instance
    
        # Mock dependency service
        mock_dep_instance = Mock()
        mock_dep_instance.get_dependencies.return_value = []
        mock_dep_instance.get_reverse_dependencies.return_value = []
        mock_dep_service.return_value = mock_dep_instance
    
        # Run command
        result = runner.invoke(task_trace, ["task-001", "--format", "table"])
    
        # Assertions
>       assert result.exit_code == 0
E       assert 1 == 0
E        +  where 1 = <Result TypeError("Console.print() got an unexpected keyword argument 'err'")>.exit_code

tests/unit/cli/test_task_trace.py:218: AssertionError
___________________ TestTaskTraceCommand.test_task_not_found ___________________

self = <cli.test_task_trace.TestTaskTraceCommand object at 0x10a4c0d60>
mock_get_db = <MagicMock name='get_db' id='4497725088'>
runner = <click.testing.CliRunner object at 0x10c2a11d0>

    @patch("agentos.cli.commands.task_trace.get_db")
    def test_task_not_found(self, mock_get_db, runner):
        """Test error when task not found"""
        mock_db = Mock()
        mock_get_db.return_value = mock_db
    
        cursor_mock = Mock()
        cursor_mock.fetchone.return_value = None
        mock_db.execute.return_value = cursor_mock
    
        result = runner.invoke(task_trace, ["nonexistent-task"])
    
        assert result.exit_code == 1
>       assert "not found" in result.output.lower()
E       assert 'not found' in ''
E        +  where '' = <built-in method lower of str object at 0x103243318>()
E        +    where <built-in method lower of str object at 0x103243318> = ''.lower
E        +      where '' = <Result TypeError("Console.print() got an unexpected keyword argument 'err'")>.output

tests/unit/cli/test_task_trace.py:300: AssertionError
_______________ TestProbeReadAccess.test_successful_read_access ________________

self = <test_probe.TestProbeReadAccess object at 0x10a54a490>
git_client = <agentos.core.git.client.GitClientWithAuth object at 0x10c15ecf0>
ssh_profile = AuthProfile(profile_id='test-ssh-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, ssh_... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

        def test_successful_read_access(self, git_client, ssh_profile):
            """Test successful read access probe"""
            ls_remote_output = """
    abc123def456\trefs/heads/main
    789xyz012345\trefs/heads/develop
    111222333444\trefs/tags/v1.0.0
    """
    
            with patch("subprocess.run") as mock_run:
                mock_run.return_value = Mock(
                    returncode=0,
                    stdout=ls_remote_output,
                    stderr="",
                )
    
                can_read, error, remote_info = git_client._probe_read_access(
                    "git@github.com:test/repo",
                    ssh_profile,
                )
    
>               assert can_read is True
E               assert False is True

tests/unit/git/test_probe.py:84: AssertionError
_______________ TestProbeReadAccess.test_read_access_denied_ssh ________________

self = <test_probe.TestProbeReadAccess object at 0x10a54a5d0>
git_client = <agentos.core.git.client.GitClientWithAuth object at 0x10c12bd90>
ssh_profile = AuthProfile(profile_id='test-ssh-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, ssh_... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    def test_read_access_denied_ssh(self, git_client, ssh_profile):
        """Test read access denied with SSH"""
        with patch("subprocess.run") as mock_run:
            mock_run.side_effect = subprocess.CalledProcessError(
                returncode=128,
                cmd=["git", "ls-remote"],
                stderr="Permission denied (publickey)",
            )
    
            can_read, error, remote_info = git_client._probe_read_access(
                "git@github.com:test/repo",
                ssh_profile,
            )
    
            assert can_read is False
>           assert "Permission denied" in error
E           AssertionError: assert 'Permission denied' in 'SSH key not found: /Users/pangge/.ssh/id_rsa'

tests/unit/git/test_probe.py:107: AssertionError
_________________ TestProbeReadAccess.test_read_access_timeout _________________

self = <test_probe.TestProbeReadAccess object at 0x10a4c36f0>
git_client = <agentos.core.git.client.GitClientWithAuth object at 0x10c13d6e0>
ssh_profile = AuthProfile(profile_id='test-ssh-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, ssh_... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    def test_read_access_timeout(self, git_client, ssh_profile):
        """Test read access timeout"""
        with patch("subprocess.run") as mock_run:
            mock_run.side_effect = subprocess.TimeoutExpired(
                cmd=["git", "ls-remote"],
                timeout=30,
            )
    
            can_read, error, remote_info = git_client._probe_read_access(
                "git@github.com:test/repo",
                ssh_profile,
            )
    
            assert can_read is False
>           assert "timeout" in error.lower()
E           AssertionError: assert 'timeout' in 'ssh key not found: /users/pangge/.ssh/id_rsa'
E            +  where 'ssh key not found: /users/pangge/.ssh/id_rsa' = <built-in method lower of str object at 0x10c3038d0>()
E            +    where <built-in method lower of str object at 0x10c3038d0> = 'SSH key not found: /Users/pangge/.ssh/id_rsa'.lower

tests/unit/git/test_probe.py:142: AssertionError
____________ TestDiagnoseError.test_diagnose_ssh_permission_denied _____________

self = <test_probe.TestDiagnoseError object at 0x10a54ac10>
git_client = <agentos.core.git.client.GitClientWithAuth object at 0x10c1d1a90>
ssh_profile = AuthProfile(profile_id='test-ssh-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, ssh_... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    def test_diagnose_ssh_permission_denied(self, git_client, ssh_profile):
        """Test SSH permission denied diagnosis"""
        error_msg = git_client._diagnose_error(
            "git@github.com:test/repo",
            ssh_profile,
            "Permission denied (publickey)",
            "read",
        )
    
        assert "SSH key authentication failed" in error_msg
>       assert "ssh -T git@github.com" in error_msg
E       AssertionError: assert 'ssh -T git@github.com' in 'SSH key authentication failed for git@github.com:test/repo.\nHints:\n  - Verify SSH key is added to your Git provider...missions: chmod 600 ~/.ssh/id_rsa\n  - Test SSH connection: ssh -T git@\n  - Verify ~/.ssh/config has correct settings'

tests/unit/git/test_probe.py:374: AssertionError
______________ TestMinerToDedupeMapper.test_convert_miner_finding ______________

self = <lead.test_contract_mapper.TestMinerToDedupeMapper object at 0x10a627390>

    def test_convert_miner_finding(self):
        """测试 Miner finding 转换"""
        window = ScanWindow(
            kind=WindowKind.HOUR_24,
            start_ts="2025-01-27T10:00:00Z",
            end_ts="2025-01-28T10:00:00Z"
        )
    
        miner_finding = MinerLeadFinding(
            finding_id="finding123",
            fingerprint="fp123abc",
            rule_code="blocked_reason_spike",
            severity="HIGH",
            title="Blocked Reason Spike Detected",
            description="ERR_TIMEOUT occurred 50 times in 24h window",
            evidence={"count": 50, "code": "ERR_TIMEOUT"},
            window=window,
            detected_at=datetime.now(timezone.utc).isoformat()
        )
    
        dedupe_finding = MinerToDedupeMapper.convert(miner_finding)
    
        # 验证字段映射
        assert dedupe_finding.fingerprint == "fp123abc"
        assert dedupe_finding.code == "blocked_reason_spike"  # rule_code -> code
        assert dedupe_finding.severity == "HIGH"
        assert dedupe_finding.title == "Blocked Reason Spike Detected"
        assert dedupe_finding.description == "ERR_TIMEOUT occurred 50 times in 24h window"
        assert dedupe_finding.window_kind == "24h"  # WindowKind enum -> string
        assert dedupe_finding.evidence == {"count": 50, "code": "ERR_TIMEOUT"}
    
        # 验证默认值
        assert dedupe_finding.count == 1
        assert dedupe_finding.linked_task_id is None
>       assert dedupe_finding.first_seen_at is None  # 由 store 设置
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert datetime.datetime(2026, 1, 28, 12, 34, 7, 517502, tzinfo=datetime.timezone.utc) is None
E        +  where datetime.datetime(2026, 1, 28, 12, 34, 7, 517502, tzinfo=datetime.timezone.utc) = <agentos.core.lead.dedupe.LeadFinding object at 0x10c0f6ba0>.first_seen_at

tests/unit/lead/test_contract_mapper.py:276: AssertionError
___ TestBackwardCompatibility.test_storage_to_miner_compatible_with_original ___

self = <lead.test_contract_mapper.TestBackwardCompatibility object at 0x10a627750>

    def test_storage_to_miner_compatible_with_original(self):
        """
        测试新 mapper 与原 lead_scan.py 的 _convert_storage_to_miner_format 行为一致
    
        这个测试确保重构后的代码与原实现完全兼容
        """
        storage_data = {
            "blocked_reasons": [
                {"code": "ERR1", "count": 2, "task_ids": ["t1", "t2"]}
            ],
            "pause_block_churn": [
                {"task_id": "t3", "pause_count": 1, "final_status": "BLOCKED"}
            ],
            "retry_then_fail": [
                {"error_code": "ERR2", "count": 1, "task_ids": ["t4"]}
            ],
            "decision_lag": {"p95_ms": 100, "samples": [50, 100]},
            "redline_ratio": {"current": 0.8, "previous": 0.6},
            "high_risk_allow": [
                {
                    "decision_id": "dec1",
                    "task_id": "t5",
                    "risk_level": "HIGH",
                    "timestamp": "2025-01-28T10:00:00Z",
                    "findings": []
                }
            ]
        }
    
        miner_data = StorageToMinerMapper.convert(storage_data)
    
        # 验证关键结构
        assert "findings" in miner_data
        assert "decisions" in miner_data
        assert "metrics" in miner_data
    
        # 验证 findings 数量（2 blocked + 1 retry_failed = 3）
        assert len(miner_data["findings"]) == 3
    
        # 验证 decisions 数量（2 pause + 1 block + 2 retry + 1 allow = 6）
>       assert len(miner_data["decisions"]) == 6
E       AssertionError: assert 5 == 6
E        +  where 5 = len([{'decision_id': 'pause_t3_0', 'decision_type': 'PAUSE', 'task_id': 't3', 'timestamp': '2025-01-28T10:00:00Z'}, {'deci...8T10:00:00Z'}, {'decision_id': 'dec1', 'decision_type': 'ALLOW', 'task_id': 't5', 'timestamp': '2025-01-28T10:00:00Z'}])

tests/unit/lead/test_contract_mapper.py:512: AssertionError
___ TestBackwardCompatibility.test_miner_to_dedupe_compatible_with_original ____

self = <lead.test_contract_mapper.TestBackwardCompatibility object at 0x10a627890>

    def test_miner_to_dedupe_compatible_with_original(self):
        """
        测试新 mapper 与原 lead_scan.py 的 _convert_miner_to_dedupe_finding 行为一致
        """
        window = ScanWindow(
            kind=WindowKind.HOUR_24,
            start_ts="2025-01-27T10:00:00Z",
            end_ts="2025-01-28T10:00:00Z"
        )
    
        miner_finding = MinerLeadFinding(
            finding_id="test_compat",
            fingerprint="fp_compat",
            rule_code="compat_rule",
            severity="medium",  # 小写
            title="Compatibility Test",
            description="Testing backward compatibility",
            evidence={"test": "data"},
            window=window,
            detected_at="2025-01-28T10:00:00Z"
        )
    
        dedupe_finding = MinerToDedupeMapper.convert(miner_finding)
    
        # 验证关键映射
        assert dedupe_finding.fingerprint == miner_finding.fingerprint
        assert dedupe_finding.code == miner_finding.rule_code
        assert dedupe_finding.severity == "MEDIUM"  # 应该转大写
        assert dedupe_finding.window_kind == "24h"  # enum -> string
        assert dedupe_finding.count == 1
        assert dedupe_finding.linked_task_id is None
>       assert dedupe_finding.first_seen_at is None
E       assert datetime.datetime(2026, 1, 28, 12, 34, 7, 538967, tzinfo=datetime.timezone.utc) is None
E        +  where datetime.datetime(2026, 1, 28, 12, 34, 7, 538967, tzinfo=datetime.timezone.utc) = <agentos.core.lead.dedupe.LeadFinding object at 0x10c1dc9e0>.first_seen_at

tests/unit/lead/test_contract_mapper.py:549: AssertionError
_________________ test_scan_result_includes_contract_versions __________________

tmp_path = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_result_includes_cont0')

    def test_scan_result_includes_contract_versions(tmp_path):
        """验证扫描结果包含契约版本信息"""
        db_path = tmp_path / "test.db"
        _create_test_database(db_path)
    
        job = LeadScanJob(db_path=db_path)
>       result = job.run_scan(window_kind="24h", dry_run=True)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/lead/test_contract_versions.py:126: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/jobs/lead_scan.py:316: in run_scan
    storage_data = self._load_storage_data(scan_window)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
agentos/jobs/lead_scan.py:426: in _load_storage_data
    "decision_lag": self.storage.get_decision_lag(window),
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.lead.adapters.storage.LeadStorage object at 0x10c23e120>
window = ScanWindow(kind=<WindowKind.HOUR_24: '24h'>, start_ts='2026-01-27T12:34:07.580191+00:00', end_ts='2026-01-28T12:34:07.580191+00:00')

    def get_decision_lag(self, window: ScanWindow) -> Dict[str, Any]:
        """
        规则4: decision_lag_anomaly
    
        返回窗口内决策延迟统计。
    
        查询逻辑（v21+ 优化）：
        1. 优先使用冗余列（source_event_ts, supervisor_processed_at）进行查询
        2. 如果冗余列不存在或为 NULL，fallback 到 payload JSON 提取（向后兼容）
        3. 计算延迟：lag_ms = supervisor_processed_at - source_event_ts
        4. 计算 p95
    
        Args:
            window: 扫描窗口
    
        Returns:
            格式: {
                "p95_ms": 5500,
                "samples": [
                    {"decision_id": "dec-1", "lag_ms": 6000},
                    {"decision_id": "dec-2", "lag_ms": 5800},
                    ...  # 最多5个样例
                ]
            }
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 检查是否有冗余列（v21+）
            cursor.execute("PRAGMA table_info(task_audits)")
            columns = {row[1] for row in cursor.fetchall()}
            has_redundant_columns = 'source_event_ts' in columns and 'supervisor_processed_at' in columns
    
            lags = []
    
            if has_redundant_columns:
                # v21+ 路径：使用冗余列（性能优化）
                cursor.execute(
                    """
                    SELECT
                        decision_id,
                        source_event_ts,
                        supervisor_processed_at,
                        created_at,
                        payload
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
    
                rows = cursor.fetchall()
    
                for row in rows:
                    decision_id = row["decision_id"]
                    source_event_ts_str = row["source_event_ts"]
                    supervisor_processed_at_str = row["supervisor_processed_at"]
                    created_at = row["created_at"]
                    payload_json = row["payload"]
    
                    # 优先使用冗余列
                    if source_event_ts_str and supervisor_processed_at_str:
                        try:
                            from datetime import datetime
                            source_ts = datetime.fromisoformat(source_event_ts_str.replace('Z', '+00:00'))
                            processed_ts = datetime.fromisoformat(supervisor_processed_at_str.replace('Z', '+00:00'))
                            lag_ms = int((processed_ts - source_ts).total_seconds() * 1000)
    
                            if lag_ms >= 0:  # 过滤负值（时钟不同步）
                                lags.append({
                                    "decision_id": decision_id or "unknown",
                                    "lag_ms": lag_ms
                                })
                                continue
                        except (ValueError, AttributeError) as e:
                            logger.warning(f"Failed to parse timestamps from columns for decision {decision_id}: {e}")
                            # Fallthrough to payload extraction
    
                    # Fallback: 从 payload JSON 提取（向后兼容）
                    if payload_json:
                        try:
                            payload = json.loads(payload_json)
                            decision_id_fb = decision_id or payload.get("decision_id", "unknown")
                            source_ts_str = payload.get("source_event_ts")
                            decision_ts_str = payload.get("supervisor_processed_at") or payload.get("timestamp")
    
                            if source_ts_str and decision_ts_str:
                                from datetime import datetime
                                source_ts = datetime.fromisoformat(source_ts_str.replace('Z', '+00:00'))
                                decision_ts = datetime.fromisoformat(decision_ts_str.replace('Z', '+00:00'))
                                lag_ms = int((decision_ts - source_ts).total_seconds() * 1000)
    
                                if lag_ms >= 0:
                                    lags.append({
                                        "decision_id": decision_id_fb,
                                        "lag_ms": lag_ms
                                    })
                        except (json.JSONDecodeError, ValueError, TypeError) as e:
                            logger.warning(f"Failed to parse lag data from payload: {e}")
                            continue
    
            else:
                # v20 及以前路径：从 payload JSON 提取（向后兼容）
>               cursor.execute(
                    """
                    SELECT decision_id, payload, created_at
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
E               sqlite3.OperationalError: no such column: decision_id

agentos/core/lead/adapters/storage.py:445: OperationalError
----------------------------- Captured stdout call -----------------------------
Starting Lead Agent scan (window=24h, dry_run=True)...
           Lead Agent 规则阈值 (v1.0.0)           
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━┓
┃ 规则                 ┃ 阈值   ┃ 说明           ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━┩
│ blocked_reason_spike │ 5      │ 相同错误码激增 │
│ pause_block_churn    │ 2      │ PAUSE 次数阈值 │
│ retry_then_fail      │ 1      │ RETRY 后失败   │
│ decision_lag         │ 5000ms │ 决策延迟 p95   │
│ redline_ratio        │ 10%    │ 占比增幅阈值   │
│ high_risk_allow      │ 1      │ 高危放行       │
└──────────────────────┴────────┴────────────────┘

Contract versions: storage=1.0.0, miner=1.0.0
Scan window: 2026-01-27T12:34:07.580191+00:00 to 
2026-01-28T12:34:07.580191+00:00
✗ Lead scan failed: no such column: decision_id
------------------------------ Captured log call -------------------------------
ERROR    agentos.jobs.lead_scan:lead_scan.py:380 Lead scan failed: no such column: decision_id
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/jobs/lead_scan.py", line 316, in run_scan
    storage_data = self._load_storage_data(scan_window)
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/jobs/lead_scan.py", line 426, in _load_storage_data
    "decision_lag": self.storage.get_decision_lag(window),
                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/lead/adapters/storage.py", line 445, in get_decision_lag
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<7 lines>...
        (window.start_ts, window.end_ts)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
sqlite3.OperationalError: no such column: decision_id
__________________ test_version_mismatch_allows_dry_run_scan ___________________

tmp_path = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_version_mismatch_allows_d0')

    def test_version_mismatch_allows_dry_run_scan(tmp_path):
        """验证版本不匹配时 dry-run 扫描允许继续"""
        db_path = tmp_path / "test.db"
        _create_test_database(db_path)
    
        job = LeadScanJob(db_path=db_path)
    
        # 模拟版本不匹配
        with patch.object(LeadStorage, 'CONTRACT_VERSION', "1.0.0"):
            with patch.object(RiskMiner, 'CONTRACT_VERSION', "2.0.0"):
                # dry-run 应该允许继续，但会输出 WARNING
>               result = job.run_scan(window_kind="24h", dry_run=True)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/lead/test_contract_versions.py:166: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/jobs/lead_scan.py:316: in run_scan
    storage_data = self._load_storage_data(scan_window)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
agentos/jobs/lead_scan.py:426: in _load_storage_data
    "decision_lag": self.storage.get_decision_lag(window),
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.lead.adapters.storage.LeadStorage object at 0x10c3b6270>
window = ScanWindow(kind=<WindowKind.HOUR_24: '24h'>, start_ts='2026-01-27T12:34:07.629472+00:00', end_ts='2026-01-28T12:34:07.629472+00:00')

    def get_decision_lag(self, window: ScanWindow) -> Dict[str, Any]:
        """
        规则4: decision_lag_anomaly
    
        返回窗口内决策延迟统计。
    
        查询逻辑（v21+ 优化）：
        1. 优先使用冗余列（source_event_ts, supervisor_processed_at）进行查询
        2. 如果冗余列不存在或为 NULL，fallback 到 payload JSON 提取（向后兼容）
        3. 计算延迟：lag_ms = supervisor_processed_at - source_event_ts
        4. 计算 p95
    
        Args:
            window: 扫描窗口
    
        Returns:
            格式: {
                "p95_ms": 5500,
                "samples": [
                    {"decision_id": "dec-1", "lag_ms": 6000},
                    {"decision_id": "dec-2", "lag_ms": 5800},
                    ...  # 最多5个样例
                ]
            }
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 检查是否有冗余列（v21+）
            cursor.execute("PRAGMA table_info(task_audits)")
            columns = {row[1] for row in cursor.fetchall()}
            has_redundant_columns = 'source_event_ts' in columns and 'supervisor_processed_at' in columns
    
            lags = []
    
            if has_redundant_columns:
                # v21+ 路径：使用冗余列（性能优化）
                cursor.execute(
                    """
                    SELECT
                        decision_id,
                        source_event_ts,
                        supervisor_processed_at,
                        created_at,
                        payload
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
    
                rows = cursor.fetchall()
    
                for row in rows:
                    decision_id = row["decision_id"]
                    source_event_ts_str = row["source_event_ts"]
                    supervisor_processed_at_str = row["supervisor_processed_at"]
                    created_at = row["created_at"]
                    payload_json = row["payload"]
    
                    # 优先使用冗余列
                    if source_event_ts_str and supervisor_processed_at_str:
                        try:
                            from datetime import datetime
                            source_ts = datetime.fromisoformat(source_event_ts_str.replace('Z', '+00:00'))
                            processed_ts = datetime.fromisoformat(supervisor_processed_at_str.replace('Z', '+00:00'))
                            lag_ms = int((processed_ts - source_ts).total_seconds() * 1000)
    
                            if lag_ms >= 0:  # 过滤负值（时钟不同步）
                                lags.append({
                                    "decision_id": decision_id or "unknown",
                                    "lag_ms": lag_ms
                                })
                                continue
                        except (ValueError, AttributeError) as e:
                            logger.warning(f"Failed to parse timestamps from columns for decision {decision_id}: {e}")
                            # Fallthrough to payload extraction
    
                    # Fallback: 从 payload JSON 提取（向后兼容）
                    if payload_json:
                        try:
                            payload = json.loads(payload_json)
                            decision_id_fb = decision_id or payload.get("decision_id", "unknown")
                            source_ts_str = payload.get("source_event_ts")
                            decision_ts_str = payload.get("supervisor_processed_at") or payload.get("timestamp")
    
                            if source_ts_str and decision_ts_str:
                                from datetime import datetime
                                source_ts = datetime.fromisoformat(source_ts_str.replace('Z', '+00:00'))
                                decision_ts = datetime.fromisoformat(decision_ts_str.replace('Z', '+00:00'))
                                lag_ms = int((decision_ts - source_ts).total_seconds() * 1000)
    
                                if lag_ms >= 0:
                                    lags.append({
                                        "decision_id": decision_id_fb,
                                        "lag_ms": lag_ms
                                    })
                        except (json.JSONDecodeError, ValueError, TypeError) as e:
                            logger.warning(f"Failed to parse lag data from payload: {e}")
                            continue
    
            else:
                # v20 及以前路径：从 payload JSON 提取（向后兼容）
>               cursor.execute(
                    """
                    SELECT decision_id, payload, created_at
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
E               sqlite3.OperationalError: no such column: decision_id

agentos/core/lead/adapters/storage.py:445: OperationalError
----------------------------- Captured stdout call -----------------------------
Starting Lead Agent scan (window=24h, dry_run=True)...
           Lead Agent 规则阈值 (v1.0.0)           
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━┓
┃ 规则                 ┃ 阈值   ┃ 说明           ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━┩
│ blocked_reason_spike │ 5      │ 相同错误码激增 │
│ pause_block_churn    │ 2      │ PAUSE 次数阈值 │
│ retry_then_fail      │ 1      │ RETRY 后失败   │
│ decision_lag         │ 5000ms │ 决策延迟 p95   │
│ redline_ratio        │ 10%    │ 占比增幅阈值   │
│ high_risk_allow      │ 1      │ 高危放行       │
└──────────────────────┴────────┴────────────────┘

Contract versions: storage=1.0.0, miner=2.0.0
⚠️  WARNING: CONTRACT_MISMATCH: Storage version (1.0.0) != Miner version 
(2.0.0). This may cause silent failures where findings=0.
Scan window: 2026-01-27T12:34:07.629472+00:00 to 
2026-01-28T12:34:07.629472+00:00
✗ Lead scan failed: no such column: decision_id
------------------------------ Captured log call -------------------------------
ERROR    agentos.jobs.lead_scan:lead_scan.py:380 Lead scan failed: no such column: decision_id
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/jobs/lead_scan.py", line 316, in run_scan
    storage_data = self._load_storage_data(scan_window)
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/jobs/lead_scan.py", line 426, in _load_storage_data
    "decision_lag": self.storage.get_decision_lag(window),
                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/lead/adapters/storage.py", line 445, in get_decision_lag
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<7 lines>...
        (window.start_ts, window.end_ts)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
sqlite3.OperationalError: no such column: decision_id
_____________ TestGetDecisionLag.test_calculates_p95_lag_correctly _____________

self = <lead.test_storage_queries.TestGetDecisionLag object at 0x10a750910>
test_db = PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmpm5dhr9ck.db')
scan_window = ScanWindow(kind=<WindowKind.HOUR_24: '24h'>, start_ts='2026-01-27T12:34:07.788747+00:00', end_ts='2026-01-28T12:34:07.788747+00:00')

    def test_calculates_p95_lag_correctly(self, test_db, scan_window):
        """正确计算决策延迟 p95"""
        # Arrange: 插入 10 个决策，延迟从 1000ms 到 10000ms
        conn = sqlite3.connect(str(test_db))
        cursor = conn.cursor()
    
        # 使用窗口结束时间作为 now，确保数据落在窗口内
        now = datetime.fromisoformat(scan_window.end_ts.replace('Z', '+00:00'))
    
        for i in range(10):
            lag_seconds = (i + 1)  # 1s, 2s, ..., 10s
            source_ts = (now - timedelta(seconds=lag_seconds))
            decision_ts = now
    
            # 将时间戳放入 payload JSON
            payload = {
                "decision_id": f"dec_{i}",
                "decision_type": "allow",
                "source_event_ts": source_ts.isoformat(),
                "timestamp": decision_ts.isoformat()
            }
    
            cursor.execute(
                """
                INSERT INTO task_audits (
                    task_id, event_type, payload, created_at
                )
                VALUES (?, ?, ?, ?)
                """,
                (
                    f"task_{i}",
                    "SUPERVISOR_DECISION",
                    json.dumps(payload),
                    decision_ts.isoformat()
                )
            )
    
        conn.commit()
        conn.close()
    
        # Act
        storage = LeadStorage(test_db)
>       result = storage.get_decision_lag(scan_window)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/lead/test_storage_queries.py:385: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.lead.adapters.storage.LeadStorage object at 0x10c3da940>
window = ScanWindow(kind=<WindowKind.HOUR_24: '24h'>, start_ts='2026-01-27T12:34:07.788747+00:00', end_ts='2026-01-28T12:34:07.788747+00:00')

    def get_decision_lag(self, window: ScanWindow) -> Dict[str, Any]:
        """
        规则4: decision_lag_anomaly
    
        返回窗口内决策延迟统计。
    
        查询逻辑（v21+ 优化）：
        1. 优先使用冗余列（source_event_ts, supervisor_processed_at）进行查询
        2. 如果冗余列不存在或为 NULL，fallback 到 payload JSON 提取（向后兼容）
        3. 计算延迟：lag_ms = supervisor_processed_at - source_event_ts
        4. 计算 p95
    
        Args:
            window: 扫描窗口
    
        Returns:
            格式: {
                "p95_ms": 5500,
                "samples": [
                    {"decision_id": "dec-1", "lag_ms": 6000},
                    {"decision_id": "dec-2", "lag_ms": 5800},
                    ...  # 最多5个样例
                ]
            }
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 检查是否有冗余列（v21+）
            cursor.execute("PRAGMA table_info(task_audits)")
            columns = {row[1] for row in cursor.fetchall()}
            has_redundant_columns = 'source_event_ts' in columns and 'supervisor_processed_at' in columns
    
            lags = []
    
            if has_redundant_columns:
                # v21+ 路径：使用冗余列（性能优化）
                cursor.execute(
                    """
                    SELECT
                        decision_id,
                        source_event_ts,
                        supervisor_processed_at,
                        created_at,
                        payload
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
    
                rows = cursor.fetchall()
    
                for row in rows:
                    decision_id = row["decision_id"]
                    source_event_ts_str = row["source_event_ts"]
                    supervisor_processed_at_str = row["supervisor_processed_at"]
                    created_at = row["created_at"]
                    payload_json = row["payload"]
    
                    # 优先使用冗余列
                    if source_event_ts_str and supervisor_processed_at_str:
                        try:
                            from datetime import datetime
                            source_ts = datetime.fromisoformat(source_event_ts_str.replace('Z', '+00:00'))
                            processed_ts = datetime.fromisoformat(supervisor_processed_at_str.replace('Z', '+00:00'))
                            lag_ms = int((processed_ts - source_ts).total_seconds() * 1000)
    
                            if lag_ms >= 0:  # 过滤负值（时钟不同步）
                                lags.append({
                                    "decision_id": decision_id or "unknown",
                                    "lag_ms": lag_ms
                                })
                                continue
                        except (ValueError, AttributeError) as e:
                            logger.warning(f"Failed to parse timestamps from columns for decision {decision_id}: {e}")
                            # Fallthrough to payload extraction
    
                    # Fallback: 从 payload JSON 提取（向后兼容）
                    if payload_json:
                        try:
                            payload = json.loads(payload_json)
                            decision_id_fb = decision_id or payload.get("decision_id", "unknown")
                            source_ts_str = payload.get("source_event_ts")
                            decision_ts_str = payload.get("supervisor_processed_at") or payload.get("timestamp")
    
                            if source_ts_str and decision_ts_str:
                                from datetime import datetime
                                source_ts = datetime.fromisoformat(source_ts_str.replace('Z', '+00:00'))
                                decision_ts = datetime.fromisoformat(decision_ts_str.replace('Z', '+00:00'))
                                lag_ms = int((decision_ts - source_ts).total_seconds() * 1000)
    
                                if lag_ms >= 0:
                                    lags.append({
                                        "decision_id": decision_id_fb,
                                        "lag_ms": lag_ms
                                    })
                        except (json.JSONDecodeError, ValueError, TypeError) as e:
                            logger.warning(f"Failed to parse lag data from payload: {e}")
                            continue
    
            else:
                # v20 及以前路径：从 payload JSON 提取（向后兼容）
>               cursor.execute(
                    """
                    SELECT decision_id, payload, created_at
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
E               sqlite3.OperationalError: no such column: decision_id

agentos/core/lead/adapters/storage.py:445: OperationalError
____________ TestGetDecisionLag.test_returns_zero_when_no_lag_data _____________

self = <lead.test_storage_queries.TestGetDecisionLag object at 0x10a750a50>
test_db = PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmp1u68u01n.db')
scan_window = ScanWindow(kind=<WindowKind.HOUR_24: '24h'>, start_ts='2026-01-27T12:34:07.809184+00:00', end_ts='2026-01-28T12:34:07.809184+00:00')

    def test_returns_zero_when_no_lag_data(self, test_db, scan_window):
        """当没有延迟数据时，返回零值"""
        # Act
        storage = LeadStorage(test_db)
>       result = storage.get_decision_lag(scan_window)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/lead/test_storage_queries.py:395: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.lead.adapters.storage.LeadStorage object at 0x10c4b5cc0>
window = ScanWindow(kind=<WindowKind.HOUR_24: '24h'>, start_ts='2026-01-27T12:34:07.809184+00:00', end_ts='2026-01-28T12:34:07.809184+00:00')

    def get_decision_lag(self, window: ScanWindow) -> Dict[str, Any]:
        """
        规则4: decision_lag_anomaly
    
        返回窗口内决策延迟统计。
    
        查询逻辑（v21+ 优化）：
        1. 优先使用冗余列（source_event_ts, supervisor_processed_at）进行查询
        2. 如果冗余列不存在或为 NULL，fallback 到 payload JSON 提取（向后兼容）
        3. 计算延迟：lag_ms = supervisor_processed_at - source_event_ts
        4. 计算 p95
    
        Args:
            window: 扫描窗口
    
        Returns:
            格式: {
                "p95_ms": 5500,
                "samples": [
                    {"decision_id": "dec-1", "lag_ms": 6000},
                    {"decision_id": "dec-2", "lag_ms": 5800},
                    ...  # 最多5个样例
                ]
            }
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 检查是否有冗余列（v21+）
            cursor.execute("PRAGMA table_info(task_audits)")
            columns = {row[1] for row in cursor.fetchall()}
            has_redundant_columns = 'source_event_ts' in columns and 'supervisor_processed_at' in columns
    
            lags = []
    
            if has_redundant_columns:
                # v21+ 路径：使用冗余列（性能优化）
                cursor.execute(
                    """
                    SELECT
                        decision_id,
                        source_event_ts,
                        supervisor_processed_at,
                        created_at,
                        payload
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
    
                rows = cursor.fetchall()
    
                for row in rows:
                    decision_id = row["decision_id"]
                    source_event_ts_str = row["source_event_ts"]
                    supervisor_processed_at_str = row["supervisor_processed_at"]
                    created_at = row["created_at"]
                    payload_json = row["payload"]
    
                    # 优先使用冗余列
                    if source_event_ts_str and supervisor_processed_at_str:
                        try:
                            from datetime import datetime
                            source_ts = datetime.fromisoformat(source_event_ts_str.replace('Z', '+00:00'))
                            processed_ts = datetime.fromisoformat(supervisor_processed_at_str.replace('Z', '+00:00'))
                            lag_ms = int((processed_ts - source_ts).total_seconds() * 1000)
    
                            if lag_ms >= 0:  # 过滤负值（时钟不同步）
                                lags.append({
                                    "decision_id": decision_id or "unknown",
                                    "lag_ms": lag_ms
                                })
                                continue
                        except (ValueError, AttributeError) as e:
                            logger.warning(f"Failed to parse timestamps from columns for decision {decision_id}: {e}")
                            # Fallthrough to payload extraction
    
                    # Fallback: 从 payload JSON 提取（向后兼容）
                    if payload_json:
                        try:
                            payload = json.loads(payload_json)
                            decision_id_fb = decision_id or payload.get("decision_id", "unknown")
                            source_ts_str = payload.get("source_event_ts")
                            decision_ts_str = payload.get("supervisor_processed_at") or payload.get("timestamp")
    
                            if source_ts_str and decision_ts_str:
                                from datetime import datetime
                                source_ts = datetime.fromisoformat(source_ts_str.replace('Z', '+00:00'))
                                decision_ts = datetime.fromisoformat(decision_ts_str.replace('Z', '+00:00'))
                                lag_ms = int((decision_ts - source_ts).total_seconds() * 1000)
    
                                if lag_ms >= 0:
                                    lags.append({
                                        "decision_id": decision_id_fb,
                                        "lag_ms": lag_ms
                                    })
                        except (json.JSONDecodeError, ValueError, TypeError) as e:
                            logger.warning(f"Failed to parse lag data from payload: {e}")
                            continue
    
            else:
                # v20 及以前路径：从 payload JSON 提取（向后兼容）
>               cursor.execute(
                    """
                    SELECT decision_id, payload, created_at
                    FROM task_audits
                    WHERE event_type LIKE 'SUPERVISOR_%'
                      AND created_at >= ?
                      AND created_at <= ?
                    ORDER BY created_at DESC
                    """,
                    (window.start_ts, window.end_ts)
                )
E               sqlite3.OperationalError: no such column: decision_id

agentos/core/lead/adapters/storage.py:445: OperationalError
________________ TestGetCheckpoint.test_get_checkpoint_existing ________________

self = <supervisor.test_event_poller.TestGetCheckpoint object at 0x10a830a50>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c367490>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_get_checkpoint_existing0/test_poller.db')

    def test_get_checkpoint_existing(self, event_poller, temp_db):
        """Test getting existing checkpoint"""
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        # Insert checkpoint
        cursor.execute(
            """
            INSERT INTO supervisor_checkpoint (source_table, last_seen_id)
            VALUES (?, ?)
            """,
            ("task_audits", 42),
        )
        conn.commit()
    
>       checkpoint = event_poller._get_checkpoint(cursor)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c367490>
cursor = <sqlite3.Cursor object at 0x10c5e9a40>

    def _get_checkpoint(self, cursor: sqlite3.Cursor) -> int:
        """
        获取当前 checkpoint
    
        Args:
            cursor: 数据库游标
    
        Returns:
            last_seen_id（如果不存在则返回 0）
        """
        cursor.execute(
            """
            SELECT last_seen_id
            FROM supervisor_checkpoint
            WHERE source_table = ?
            """,
            (self.source_table,),
        )
    
        row = cursor.fetchone()
>       return row["last_seen_id"] if row else 0
               ^^^^^^^^^^^^^^^^^^^
E       TypeError: tuple indices must be integers or slices, not str

agentos/core/supervisor/poller.py:147: TypeError
_____________ TestConvertToSupervisorEvent.test_convert_basic_row ______________

self = <supervisor.test_event_poller.TestConvertToSupervisorEvent object at 0x10a831090>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c1563f0>

    def test_convert_basic_row(self, event_poller):
        """Test converting basic DB row"""
        conn = sqlite3.connect(":memory:")
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        cursor.execute(
            """
            CREATE TABLE temp (
                audit_id INTEGER,
                task_id TEXT,
                event_type TEXT,
                payload TEXT,
                created_at TEXT
            )
            """
        )
        cursor.execute(
            """
            INSERT INTO temp VALUES (1, 'task_123', 'TASK_CREATED', '{}', '2024-01-15T10:30:00+00:00')
            """
        )
        cursor.execute("SELECT * FROM temp")
        row = cursor.fetchone()
    
        conn.close()
    
>       event = event_poller._convert_to_supervisor_event(row)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:322: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c1563f0>
row = <sqlite3.Row object at 0x10c4c5390>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError
____________ TestConvertToSupervisorEvent.test_convert_with_payload ____________

self = <supervisor.test_event_poller.TestConvertToSupervisorEvent object at 0x10a8311d0>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c189040>

    def test_convert_with_payload(self, event_poller):
        """Test converting row with JSON payload"""
        conn = sqlite3.connect(":memory:")
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        cursor.execute(
            """
            CREATE TABLE temp (
                audit_id INTEGER,
                task_id TEXT,
                event_type TEXT,
                payload TEXT,
                created_at TEXT
            )
            """
        )
        cursor.execute(
            """
            INSERT INTO temp VALUES (2, 'task_456', 'TASK_STEP_COMPLETED',
                                     '{"step": 5, "status": "success"}',
                                     '2024-01-15T11:00:00+00:00')
            """
        )
        cursor.execute("SELECT * FROM temp")
        row = cursor.fetchone()
    
        conn.close()
    
>       event = event_poller._convert_to_supervisor_event(row)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:360: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c189040>
row = <sqlite3.Row object at 0x10c4c55a0>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError
________ TestConvertToSupervisorEvent.test_convert_invalid_json_payload ________

self = <supervisor.test_event_poller.TestConvertToSupervisorEvent object at 0x10a78f6f0>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c3b52b0>

    def test_convert_invalid_json_payload(self, event_poller):
        """Test converting row with invalid JSON payload"""
        conn = sqlite3.connect(":memory:")
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        cursor.execute(
            """
            CREATE TABLE temp (
                audit_id INTEGER,
                task_id TEXT,
                event_type TEXT,
                payload TEXT,
                created_at TEXT
            )
            """
        )
        cursor.execute(
            """
            INSERT INTO temp VALUES (3, 'task_789', 'TASK_FAILED',
                                     'invalid json',
                                     '2024-01-15T12:00:00+00:00')
            """
        )
        cursor.execute("SELECT * FROM temp")
        row = cursor.fetchone()
    
        conn.close()
    
>       event = event_poller._convert_to_supervisor_event(row)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:393: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3b52b0>
row = <sqlite3.Row object at 0x10c4c5b70>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError
________________________ TestScan.test_scan_with_events ________________________

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c6294a0>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
>                   supervisor_event = self._convert_to_supervisor_event(event_row)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

agentos/core/supervisor/poller.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c6294a0>
row = <sqlite3.Row object at 0x10c4c5cc0>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError

During handling of the above exception, another exception occurred:

self = <supervisor.test_event_poller.TestScan object at 0x10a831450>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c6294a0>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_with_events0/test_poller.db')

    def test_scan_with_events(self, event_poller, temp_db):
        """Test scanning with new events"""
        # Insert events into task_audits
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        for i in range(3):
            cursor.execute(
                """
                INSERT INTO task_audits (task_id, event_type, payload)
                VALUES (?, ?, ?)
                """,
                (f"task_{i}", "TASK_CREATED", json.dumps({"index": i})),
            )
        conn.commit()
        conn.close()
    
        # Scan
>       count = event_poller.scan()
                ^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c6294a0>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
                    supervisor_event = self._convert_to_supervisor_event(event_row)
    
                    # 写入 inbox（去重）
                    inserted = self.inbox_manager.insert_event(supervisor_event, cursor)
    
                    if inserted:
                        inserted_count += 1
    
                    # 更新 max_id
                    event_id = event_row.get("audit_id") or event_row.get("id")
                    if event_id and event_id > max_id:
                        max_id = event_id
    
                except Exception as e:
                    logger.error(
>                       f"Error processing polled event {event_row.get('audit_id', 'unknown')}: {e}",
                                                         ^^^^^^^^^^^^^
                        exc_info=True,
                    )
E                   AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:107: AttributeError
____________________ TestScan.test_scan_updates_checkpoint _____________________

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6690>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
>                   supervisor_event = self._convert_to_supervisor_event(event_row)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

agentos/core/supervisor/poller.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6690>
row = <sqlite3.Row object at 0x10c4c6b00>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError

During handling of the above exception, another exception occurred:

self = <supervisor.test_event_poller.TestScan object at 0x10a78f820>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6690>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_updates_checkpoint0/test_poller.db')

    def test_scan_updates_checkpoint(self, event_poller, temp_db):
        """Test that scan updates checkpoint"""
        # Insert events
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        for i in range(5):
            cursor.execute(
                """
                INSERT INTO task_audits (task_id, event_type)
                VALUES (?, ?)
                """,
                (f"task_{i}", "TASK_CREATED"),
            )
        conn.commit()
        conn.close()
    
        # Initial scan
>       event_poller.scan()

tests/unit/supervisor/test_event_poller.py:457: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6690>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
                    supervisor_event = self._convert_to_supervisor_event(event_row)
    
                    # 写入 inbox（去重）
                    inserted = self.inbox_manager.insert_event(supervisor_event, cursor)
    
                    if inserted:
                        inserted_count += 1
    
                    # 更新 max_id
                    event_id = event_row.get("audit_id") or event_row.get("id")
                    if event_id and event_id > max_id:
                        max_id = event_id
    
                except Exception as e:
                    logger.error(
>                       f"Error processing polled event {event_row.get('audit_id', 'unknown')}: {e}",
                                                         ^^^^^^^^^^^^^
                        exc_info=True,
                    )
E                   AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:107: AttributeError
________________________ TestScan.test_scan_incremental ________________________

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6d50>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
>                   supervisor_event = self._convert_to_supervisor_event(event_row)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

agentos/core/supervisor/poller.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6d50>
row = <sqlite3.Row object at 0x10c4c74c0>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError

During handling of the above exception, another exception occurred:

self = <supervisor.test_event_poller.TestScan object at 0x10a78f950>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6d50>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_incremental0/test_poller.db')

    def test_scan_incremental(self, event_poller, temp_db):
        """Test incremental scanning"""
        # Insert first batch
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        for i in range(3):
            cursor.execute(
                """
                INSERT INTO task_audits (task_id, event_type)
                VALUES (?, ?)
                """,
                (f"task_{i}", "TASK_CREATED"),
            )
        conn.commit()
        conn.close()
    
        # First scan
>       count1 = event_poller.scan()
                 ^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:489: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c3e6d50>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
                    supervisor_event = self._convert_to_supervisor_event(event_row)
    
                    # 写入 inbox（去重）
                    inserted = self.inbox_manager.insert_event(supervisor_event, cursor)
    
                    if inserted:
                        inserted_count += 1
    
                    # 更新 max_id
                    event_id = event_row.get("audit_id") or event_row.get("id")
                    if event_id and event_id > max_id:
                        max_id = event_id
    
                except Exception as e:
                    logger.error(
>                       f"Error processing polled event {event_row.get('audit_id', 'unknown')}: {e}",
                                                         ^^^^^^^^^^^^^
                        exc_info=True,
                    )
E                   AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:107: AttributeError
_______________________ TestScan.test_scan_deduplication _______________________

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c100>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
>                   supervisor_event = self._convert_to_supervisor_event(event_row)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

agentos/core/supervisor/poller.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c100>
row = <sqlite3.Row object at 0x10c4c7eb0>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError

During handling of the above exception, another exception occurred:

self = <supervisor.test_event_poller.TestScan object at 0x10a860a70>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c100>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_deduplication0/test_poller.db')

    def test_scan_deduplication(self, event_poller, temp_db):
        """Test that scan respects inbox deduplication"""
        # Insert event
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        cursor.execute(
            """
            INSERT INTO task_audits (task_id, event_type)
            VALUES (?, ?)
            """,
            ("task_123", "TASK_CREATED"),
        )
        conn.commit()
        conn.close()
    
        # First scan
>       count1 = event_poller.scan()
                 ^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:537: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c100>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
                    supervisor_event = self._convert_to_supervisor_event(event_row)
    
                    # 写入 inbox（去重）
                    inserted = self.inbox_manager.insert_event(supervisor_event, cursor)
    
                    if inserted:
                        inserted_count += 1
    
                    # 更新 max_id
                    event_id = event_row.get("audit_id") or event_row.get("id")
                    if event_id and event_id > max_id:
                        max_id = event_id
    
                except Exception as e:
                    logger.error(
>                       f"Error processing polled event {event_row.get('audit_id', 'unknown')}: {e}",
                                                         ^^^^^^^^^^^^^
                        exc_info=True,
                    )
E                   AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:107: AttributeError
______________________ TestScan.test_scan_handles_errors _______________________

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c1b0>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
>                   supervisor_event = self._convert_to_supervisor_event(event_row)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

agentos/core/supervisor/poller.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c1b0>
row = <sqlite3.Row object at 0x10c5a8310>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError

During handling of the above exception, another exception occurred:

self = <supervisor.test_event_poller.TestScan object at 0x10a69fac0>
event_poller = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c1b0>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_handles_errors0/test_poller.db')

    def test_scan_handles_errors(self, event_poller, temp_db):
        """Test that scan handles individual event errors gracefully"""
        # Insert valid and problematic events
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        cursor.execute(
            """
            INSERT INTO task_audits (task_id, event_type)
            VALUES (?, ?)
            """,
            ("task_valid", "TASK_CREATED"),
        )
        conn.commit()
        conn.close()
    
        # Scan should succeed even if some events have issues
>       count = event_poller.scan()
                ^^^^^^^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:571: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c58c1b0>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
                    supervisor_event = self._convert_to_supervisor_event(event_row)
    
                    # 写入 inbox（去重）
                    inserted = self.inbox_manager.insert_event(supervisor_event, cursor)
    
                    if inserted:
                        inserted_count += 1
    
                    # 更新 max_id
                    event_id = event_row.get("audit_id") or event_row.get("id")
                    if event_id and event_id > max_id:
                        max_id = event_id
    
                except Exception as e:
                    logger.error(
>                       f"Error processing polled event {event_row.get('audit_id', 'unknown')}: {e}",
                                                         ^^^^^^^^^^^^^
                        exc_info=True,
                    )
E                   AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:107: AttributeError
________________ TestBatchProcessing.test_scan_multiple_batches ________________

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c5c6570>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
>                   supervisor_event = self._convert_to_supervisor_event(event_row)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

agentos/core/supervisor/poller.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c5c6570>
row = <sqlite3.Row object at 0x10c4c72e0>

    def _convert_to_supervisor_event(self, row: sqlite3.Row) -> SupervisorEvent:
        """
        将数据库行转换为 SupervisorEvent
    
        Args:
            row: 数据库行
    
        Returns:
            SupervisorEvent 对象
        """
        # 解析 payload
        payload = {}
>       if row.get("payload"):
           ^^^^^^^
E       AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:209: AttributeError

During handling of the above exception, another exception occurred:

self = <supervisor.test_event_poller.TestBatchProcessing object at 0x10a831810>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_scan_multiple_batches0/test_poller.db')
inbox_manager = <agentos.core.supervisor.inbox.InboxManager object at 0x10c5c64e0>

    def test_scan_multiple_batches(self, temp_db, inbox_manager):
        """Test scanning processes multiple batches"""
        # Create poller with small batch size
        poller = EventPoller(
            db_path=temp_db, inbox_manager=inbox_manager, batch_size=5
        )
    
        # Insert more events than batch size
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
    
        for i in range(12):
            cursor.execute(
                """
                INSERT INTO task_audits (task_id, event_type)
                VALUES (?, ?)
                """,
                (f"task_{i}", "TASK_CREATED"),
            )
        conn.commit()
        conn.close()
    
        # First scan - should get batch_size events
>       count1 = poller.scan()
                 ^^^^^^^^^^^^^

tests/unit/supervisor/test_event_poller.py:644: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.supervisor.poller.EventPoller object at 0x10c5c6570>

    def scan(self) -> int:
        """
        扫描并拉取新事件
    
        Returns:
            拉取的事件数量
        """
        conn = sqlite3.connect(str(self.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
    
        try:
            # 获取 checkpoint
            last_seen_id = self._get_checkpoint(cursor)
            logger.debug(f"Checkpoint: last_seen_id={last_seen_id}")
    
            # 拉取新事件
            events = self._fetch_new_events(cursor, last_seen_id)
    
            if not events:
                logger.debug("No new events to poll")
                return 0
    
            logger.info(f"Polling {len(events)} new events from {self.source_table}")
    
            # 写入 inbox
            inserted_count = 0
            max_id = last_seen_id
    
            for event_row in events:
                try:
                    # 转换为 SupervisorEvent
                    supervisor_event = self._convert_to_supervisor_event(event_row)
    
                    # 写入 inbox（去重）
                    inserted = self.inbox_manager.insert_event(supervisor_event, cursor)
    
                    if inserted:
                        inserted_count += 1
    
                    # 更新 max_id
                    event_id = event_row.get("audit_id") or event_row.get("id")
                    if event_id and event_id > max_id:
                        max_id = event_id
    
                except Exception as e:
                    logger.error(
>                       f"Error processing polled event {event_row.get('audit_id', 'unknown')}: {e}",
                                                         ^^^^^^^^^^^^^
                        exc_info=True,
                    )
E                   AttributeError: 'sqlite3.Row' object has no attribute 'get'

agentos/core/supervisor/poller.py:107: AttributeError
__________________ TestOnEvent.test_on_event_duplicate_event ___________________

self = <supervisor.test_subscriber.TestOnEvent object at 0x10a8b0b90>
subscriber = <agentos.core.supervisor.subscriber.SupervisorSubscriber object at 0x10c33b770>
mock_supervisor_service = <Mock id='4501540208'>
inbox_manager = <agentos.core.supervisor.inbox.InboxManager object at 0x10c5b6b20>
temp_db = PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/pytest-of-pangge/pytest-39/test_on_event_duplicate_event0/test_subscriber.db')

    def test_on_event_duplicate_event(
        self, subscriber, mock_supervisor_service, inbox_manager, temp_db
    ):
        """Test handling duplicate event (deduplication)"""
        mock_event = self.MockEventBusEvent(
            entity_id="task_456",
            event_type="TASK_CREATED",
            ts="2024-01-15T10:30:00+00:00",
            payload={},
        )
    
        # Handle event twice
        subscriber.on_event(mock_event)
        subscriber.on_event(mock_event)
    
        # Supervisor should be woken only once (for first event)
>       assert mock_supervisor_service.wake.call_count == 1
E       AssertionError: assert 2 == 1
E        +  where 2 = <Mock name='mock.wake' id='4501539872'>.call_count
E        +    where <Mock name='mock.wake' id='4501539872'> = <Mock id='4501540208'>.wake

tests/unit/supervisor/test_subscriber.py:182: AssertionError
________________ TestWakeupBehavior.test_no_wakeup_on_duplicate ________________

self = <supervisor.test_subscriber.TestWakeupBehavior object at 0x10a8b1090>
subscriber = <agentos.core.supervisor.subscriber.SupervisorSubscriber object at 0x10c2a2350>
mock_supervisor_service = <Mock id='4501546592'>

    def test_no_wakeup_on_duplicate(self, subscriber, mock_supervisor_service):
        """Test that supervisor is not woken on duplicate event"""
        mock_event = self.MockEventBusEvent(
            entity_id="task_dup",
            event_type="TASK_CREATED",
            ts="2024-01-15T10:30:00+00:00",
            payload={},
        )
    
        # First event - should wake
        subscriber.on_event(mock_event)
        assert mock_supervisor_service.wake.call_count == 1
    
        # Duplicate - should not wake
        subscriber.on_event(mock_event)
>       assert mock_supervisor_service.wake.call_count == 1
E       AssertionError: assert 2 == 1
E        +  where 2 = <Mock name='mock.wake' id='4501546256'>.call_count
E        +    where <Mock name='mock.wake' id='4501546256'> = <Mock id='4501546592'>.wake

tests/unit/supervisor/test_subscriber.py:371: AssertionError
_________________ TestPathFilter.test_simple_pattern_matching __________________

self = <test_path_filter.TestPathFilter object at 0x10a8b2d50>

    def test_simple_pattern_matching(self):
        """Test simple pattern matching"""
        filter = PathFilter(patterns=["src/**/*.py"])
    
        # Should allow
>       assert filter.is_allowed("src/main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src/main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:22: AssertionError
____________________ TestPathFilter.test_multiple_patterns _____________________

self = <test_path_filter.TestPathFilter object at 0x10a8b3d90>

    def test_multiple_patterns(self):
        """Test multiple inclusion patterns"""
        filter = PathFilter(patterns=["src/**/*.py", "lib/**/*.py"])
    
>       assert filter.is_allowed("src/main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src/main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py', 'lib/**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:35: AssertionError
____________________ TestPathFilter.test_wildcard_patterns _____________________

self = <test_path_filter.TestPathFilter object at 0x10a905d90>

    def test_wildcard_patterns(self):
        """Test wildcard * patterns"""
        filter = PathFilter(patterns=["*.py"])
    
>       assert filter.is_allowed("main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('main.py')
E        +    where is_allowed = PathFilter(patterns=['*.py']).is_allowed

tests/unit/task/test_path_filter.py:63: AssertionError
____________________ TestPathFilter.test_recursive_wildcard ____________________

self = <test_path_filter.TestPathFilter object at 0x10a849d00>

    def test_recursive_wildcard(self):
        """Test recursive ** wildcard"""
        filter = PathFilter(patterns=["**/test_*.py"])
    
>       assert filter.is_allowed("test_main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('test_main.py')
E        +    where is_allowed = PathFilter(patterns=['**/test_*.py']).is_allowed

tests/unit/task/test_path_filter.py:70: AssertionError
____________________ TestPathFilter.test_path_normalization ____________________

self = <test_path_filter.TestPathFilter object at 0x10a891350>

    def test_path_normalization(self):
        """Test path normalization (forward slashes)"""
        filter = PathFilter(patterns=["src/**/*.py"])
    
        # Test with backslashes (Windows style)
>       assert filter.is_allowed("src\\main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src\\main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:87: AssertionError
_______________________ TestPathFilter.test_filter_files _______________________

self = <test_path_filter.TestPathFilter object at 0x10a891450>

    def test_filter_files(self):
        """Test filtering a list of files"""
        filter = PathFilter(patterns=["src/**/*.py", "!src/**/*_test.py"])
    
        files = [
            "src/main.py",
            "src/utils.py",
            "src/test_main.py",
            "lib/helper.py",
            "tests/test_utils.py",
        ]
    
        filtered = filter.filter_files(files)
    
>       assert "src/main.py" in filtered
E       AssertionError: assert 'src/main.py' in []

tests/unit/task/test_path_filter.py:108: AssertionError
____________________ TestPathFilter.test_get_allowed_count _____________________

self = <test_path_filter.TestPathFilter object at 0x10a792e40>

    def test_get_allowed_count(self):
        """Test counting allowed files"""
        filter = PathFilter(patterns=["**/*.py"])
    
        files = ["main.py", "utils.py", "README.md", "config.json"]
    
        count = filter.get_allowed_count(files)
>       assert count == 2
E       assert 0 == 2

tests/unit/task/test_path_filter.py:121: AssertionError
_______________ TestPathFilter.test_complex_pattern_combination ________________

self = <test_path_filter.TestPathFilter object at 0x10a792f30>

    def test_complex_pattern_combination(self):
        """Test complex pattern combinations"""
        filter = PathFilter(
            patterns=[
                "src/**/*.py",
                "lib/**/*.py",
                "!**/*_test.py",
                "!**/test_*.py",
                "!tests/**",
            ]
        )
    
        # Should allow
>       assert filter.is_allowed("src/main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src/main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py', 'lib/**/*.py', '!**/*_test.py', '!**/test_*.py', '!tests/**']).is_allowed

tests/unit/task/test_path_filter.py:136: AssertionError
___________________ TestPathFilterBuilder.test_builder_basic ___________________

self = <test_path_filter.TestPathFilterBuilder object at 0x10a8b3ed0>

    def test_builder_basic(self):
        """Test basic builder usage"""
        filter = (
            PathFilterBuilder()
            .include("src/**/*.py")
            .include("lib/**/*.py")
            .build()
        )
    
>       assert filter.is_allowed("src/main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src/main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py', 'lib/**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:177: AssertionError
________________ TestPathFilterBuilder.test_builder_include_all ________________

self = <test_path_filter.TestPathFilterBuilder object at 0x10a87f230>

    def test_builder_include_all(self):
        """Test builder include_all method"""
        filter = PathFilterBuilder().include_all().build()
    
        assert filter.is_allowed("any/file.py")
>       assert filter.is_allowed("main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('main.py')
E        +    where is_allowed = PathFilter(patterns=['**/*']).is_allowed

tests/unit/task/test_path_filter.py:199: AssertionError
_______________ TestPathFilterFactories.test_create_path_filter ________________

self = <test_path_filter.TestPathFilterFactories object at 0x10a954190>

    def test_create_path_filter(self):
        """Test create_path_filter factory"""
        filter = create_path_filter(["src/**/*.py"])
    
        assert isinstance(filter, PathFilter)
>       assert filter.is_allowed("src/main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src/main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:225: AssertionError
____________ TestPathFilterFactories.test_create_full_access_filter ____________

self = <test_path_filter.TestPathFilterFactories object at 0x10a9542d0>

    def test_create_full_access_filter(self):
        """Test create_full_access_filter factory"""
        filter = create_full_access_filter()
    
        assert filter.is_allowed("any/file.py")
>       assert filter.is_allowed("main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('main.py')
E        +    where is_allowed = PathFilter(patterns=['**/*']).is_allowed

tests/unit/task/test_path_filter.py:232: AssertionError
_____________ TestPathFilterFactories.test_create_readonly_filter ______________

self = <test_path_filter.TestPathFilterFactories object at 0x10a87f490>

    def test_create_readonly_filter(self):
        """Test create_readonly_filter factory"""
        filter = create_readonly_filter(["src/**/*.py", "lib/**/*.py"])
    
>       assert filter.is_allowed("src/main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('src/main.py')
E        +    where is_allowed = PathFilter(patterns=['src/**/*.py', 'lib/**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:239: AssertionError
____________________ TestPathFilterEdgeCases.test_root_file ____________________

self = <test_path_filter.TestPathFilterEdgeCases object at 0x10a954550>

    def test_root_file(self):
        """Test root-level file matching"""
        filter = PathFilter(patterns=["*.py"])
    
>       assert filter.is_allowed("main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('main.py')
E        +    where is_allowed = PathFilter(patterns=['*.py']).is_allowed

tests/unit/task/test_path_filter.py:257: AssertionError
________________ TestPathFilterEdgeCases.test_pattern_with_dots ________________

self = <test_path_filter.TestPathFilterEdgeCases object at 0x10a87f5c0>

    def test_pattern_with_dots(self):
        """Test patterns with dots in filename"""
        filter = PathFilter(patterns=["**/*.test.js"])
    
>       assert filter.is_allowed("main.test.js")
E       AssertionError: assert False
E        +  where False = is_allowed('main.test.js')
E        +    where is_allowed = PathFilter(patterns=['**/*.test.js']).is_allowed

tests/unit/task/test_path_filter.py:264: AssertionError
________________ TestPathFilterEdgeCases.test_case_sensitivity _________________

self = <test_path_filter.TestPathFilterEdgeCases object at 0x10a87f6f0>

    def test_case_sensitivity(self):
        """Test case sensitivity in pattern matching"""
        filter = PathFilter(patterns=["**/*.py"])
    
        # fnmatch is case-sensitive on Unix, case-insensitive on Windows
        # We test the expected behavior on Unix
>       assert filter.is_allowed("main.py")
E       AssertionError: assert False
E        +  where False = is_allowed('main.py')
E        +    where is_allowed = PathFilter(patterns=['**/*.py']).is_allowed

tests/unit/task/test_path_filter.py:274: AssertionError
______________________ test_cannot_approve_approved_task _______________________

task_service = <agentos.core.task.service.TaskService object at 0x10c77d370>

    def test_cannot_approve_approved_task(task_service):
        """Test that approving an already approved task raises error"""
        task = task_service.create_draft_task(
            title="Test Task",
            created_by="test_user"
        )
        task_service.approve_task(task.task_id, "approver", "Approved")
    
>       with pytest.raises(InvalidTransitionError) as exc_info:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       Failed: DID NOT RAISE <class 'agentos.core.task.errors.InvalidTransitionError'>

tests/unit/task/test_task_api_enforces_state_machine.py:335: Failed
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HPB2BS68MSB39XGAST98: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.service:service.py:213 Task routing failed for task 01KG29HPB2BS68MSB39XGAST98: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 211, in create_draft_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
________________________ test_restart_creates_new_task _________________________

task_service = <agentos.core.task.service.TaskService object at 0x10c7b4d10>
rollback_service = <agentos.core.task.rollback.TaskRollbackService object at 0x10c74c250>

    def test_restart_creates_new_task(task_service, rollback_service):
        """Test that restart creates a new task with new task_id"""
        original_task = task_service.create_draft_task(
            title="Original Task",
            created_by="user"
        )
    
        # Restart as new draft
        new_task = rollback_service.create_new_draft_from_task(
            source_task_id=original_task.task_id,
            actor="user",
            reason="Retrying with updates"
        )
    
        # Should have different task_id
        assert new_task.task_id != original_task.task_id
    
        # Should be in draft state
>       assert new_task.status == TaskState.DRAFT.value
E       AssertionError: assert 'created' == 'draft'
E         
E         - draft
E         + created

tests/unit/task/test_task_rollback_rules.py:271: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HRFWXT34J0WBRWPZM94P: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.service:service.py:213 Task routing failed for task 01KG29HRFWXT34J0WBRWPZM94P: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 211, in create_draft_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HRJ6GPEN75EDT10ZVWX2: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.manager:manager.py:176 Task routing failed for task 01KG29HRJ6GPEN75EDT10ZVWX2: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 174, in create_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_________________________ test_restart_from_any_state __________________________

task_service = <agentos.core.task.service.TaskService object at 0x10c7b6ed0>
rollback_service = <agentos.core.task.rollback.TaskRollbackService object at 0x10c3b51d0>

    def test_restart_from_any_state(task_service, rollback_service):
        """Test that restart works from any state"""
        # Test from each state
        states_to_test = [
            (TaskState.DRAFT, lambda t: t),
            (TaskState.APPROVED, lambda t: task_service.approve_task(t.task_id, "a", "r")),
            (TaskState.QUEUED, lambda t: (
                task_service.approve_task(t.task_id, "a", "r"),
                task_service.queue_task(t.task_id, "s", "r")
            )[-1]),
        ]
    
        for state, setup_fn in states_to_test:
            task = task_service.create_draft_task(
                title=f"Task in {state.value}",
                created_by="user"
            )
            task = setup_fn(task)
    
            # Restart should work
            new_task = rollback_service.create_new_draft_from_task(
                source_task_id=task.task_id,
                actor="user",
                reason=f"Restart from {state.value}"
            )
    
            assert new_task.task_id != task.task_id
>           assert new_task.status == TaskState.DRAFT.value
E           AssertionError: assert 'created' == 'draft'
E             
E             - draft
E             + created

tests/unit/task/test_task_rollback_rules.py:414: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HS8NTB2BCNVBQ7PZT9EQ: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.service:service.py:213 Task routing failed for task 01KG29HS8NTB2BCNVBQ7PZT9EQ: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 211, in create_draft_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HSB4328BE1JMHBT437QH: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.manager:manager.py:176 Task routing failed for task 01KG29HSB4328BE1JMHBT437QH: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 174, in create_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_______________ test_full_rollback_scenario_restart_failed_task ________________

task_service = <agentos.core.task.service.TaskService object at 0x10c7f35f0>
rollback_service = <agentos.core.task.rollback.TaskRollbackService object at 0x10c7f3890>

    def test_full_rollback_scenario_restart_failed_task(task_service, rollback_service):
        """Test full scenario: restart a failed task as new draft"""
        # Create and run task to failure
        task = task_service.create_draft_task(title="Deploy Service", created_by="ops")
        task = task_service.approve_task(task.task_id, "ops_lead", "Approved")
        task = task_service.queue_task(task.task_id, "scheduler", "Queued")
        task = task_service.start_task(task.task_id, "runner", "Running")
        failed_task = task_service.fail_task(
            task.task_id,
            "runner",
            "Network timeout during deployment"
        )
    
        # Restart as new draft after fix
        new_task = rollback_service.create_new_draft_from_task(
            source_task_id=failed_task.task_id,
            actor="ops",
            reason="Retrying after network issue resolved",
            title_override="[Retry] Deploy Service"
        )
    
        # Verify new task
        assert new_task.task_id != failed_task.task_id
>       assert new_task.status == TaskState.DRAFT.value
E       AssertionError: assert 'created' == 'draft'
E         
E         - draft
E         + created

tests/unit/task/test_task_rollback_rules.py:690: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HTKXTZ3S6GRX2SY838WA: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.service:service.py:213 Task routing failed for task 01KG29HTKXTZ3S6GRX2SY838WA: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/service.py", line 211, in create_draft_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.routing_service:routing_service.py:102 Routing failed for task 01KG29HTPF474PNE9QJCZCNNSD: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
ERROR    agentos.core.task.manager:manager.py:176 Task routing failed for task 01KG29HTPF474PNE9QJCZCNNSD: FOREIGN KEY constraint failed
Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 85, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<8 lines>...
        },
        ^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 174, in create_task
    asyncio.run(routing_service.route_new_task(task.task_id, task_spec))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/routing_service.py", line 104, in route_new_task
    self.task_manager.add_audit(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        task_id=task_id,
        ^^^^^^^^^^^^^^^^
    ...<2 lines>...
        payload={"error": str(e)},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/pangge/PycharmProjects/AgentOS/agentos/core/task/manager.py", line 562, in add_audit
    cursor.execute(
    ~~~~~~~~~~~~~~^
        """
        ^^^
    ...<9 lines>...
        )
        ^
    )
    ^
sqlite3.IntegrityError: FOREIGN KEY constraint failed
_______________ TestGitClientWithAuth.test_clone_with_pat_token ________________

self = <test_git.test_client.TestGitClientWithAuth object at 0x10aa0a210>
mock_path = <MagicMock name='Path' id='4502447040'>
mock_subprocess = <MagicMock name='run' id='4502452080'>
mock_credentials_manager = <Mock spec='CredentialsManager' id='4502441328'>
pat_profile = AuthProfile(profile_id='pat-profile-id', profile_name='test-github', profile_type=<AuthProfileType.PAT_TOKEN: 'pat_tok... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    @patch("agentos.core.git.client.subprocess.run")
    @patch("agentos.core.git.client.Path")
    def test_clone_with_pat_token(
        self,
        mock_path,
        mock_subprocess,
        mock_credentials_manager,
        pat_profile,
    ):
        """Test cloning with PAT token"""
        client = GitClientWithAuth(mock_credentials_manager)
    
        # Mock profile retrieval
        mock_credentials_manager.get_profile.return_value = pat_profile
    
        # Mock subprocess success
        mock_subprocess.return_value = Mock(returncode=0)
    
        # Mock path
        dest_path = Path("/tmp/test-repo")
    
        # Clone
>       result = client.clone(
            remote_url="https://github.com/user/repo.git",
            dest_path=dest_path,
            auth_profile="test-github",
        )

tests/unit/test_git/test_client.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/core/git/client.py:178: in clone
    return GitClient(dest_path)
           ^^^^^^^^^^^^^^^^^^^^
agentos/core/infra/git_client.py:27: in __init__
    self.repo = Repo(str(repo_path))
                ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'Repo' object has no attribute 'git_dir'") raised in repr()] Repo object at 0x10c472360>
path = '/tmp/test-repo', odbt = <class 'git.db.GitCmdObjectDB'>
search_parent_directories = False, expand_vars = True

    def __init__(
        self,
        path: Optional[PathLike] = None,
        odbt: Type[LooseObjectDB] = GitCmdObjectDB,
        search_parent_directories: bool = False,
        expand_vars: bool = True,
    ) -> None:
        R"""Create a new :class:`Repo` instance.
    
        :param path:
            The path to either the worktree directory or the .git directory itself::
    
                repo = Repo("/Users/mtrier/Development/git-python")
                repo = Repo("/Users/mtrier/Development/git-python.git")
                repo = Repo("~/Development/git-python.git")
                repo = Repo("$REPOSITORIES/Development/git-python.git")
                repo = Repo(R"C:\Users\mtrier\Development\git-python\.git")
    
            - In *Cygwin*, `path` may be a ``cygdrive/...`` prefixed path.
            - If `path` is ``None`` or an empty string, :envvar:`GIT_DIR` is used. If
              that environment variable is absent or empty, the current directory is
              used.
    
        :param odbt:
            Object DataBase type - a type which is constructed by providing the
            directory containing the database objects, i.e. ``.git/objects``. It will be
            used to access all object data.
    
        :param search_parent_directories:
            If ``True``, all parent directories will be searched for a valid repo as
            well.
    
            Please note that this was the default behaviour in older versions of
            GitPython, which is considered a bug though.
    
        :raise git.exc.InvalidGitRepositoryError:
    
        :raise git.exc.NoSuchPathError:
    
        :return:
            :class:`Repo`
        """
    
        epath = path or os.getenv("GIT_DIR")
        if not epath:
            epath = os.getcwd()
        epath = os.fspath(epath)
        if Git.is_cygwin():
            # Given how the tests are written, this seems more likely to catch Cygwin
            # git used from Windows than Windows git used from Cygwin. Therefore
            # changing to Cygwin-style paths is the relevant operation.
            epath = cygpath(epath)
    
        if expand_vars and re.search(self.re_envvars, epath):
            warnings.warn(
                "The use of environment variables in paths is deprecated"
                + "\nfor security reasons and may be removed in the future!!",
                stacklevel=1,
            )
        epath = expand_path(epath, expand_vars)
        if epath is not None:
            if not os.path.exists(epath):
>               raise NoSuchPathError(epath)
E               git.exc.NoSuchPathError: /tmp/test-repo

.venv/lib/python3.13/site-packages/git/repo/base.py:235: NoSuchPathError
________________ TestGitClientWithAuth.test_clone_with_ssh_key _________________

self = <test_git.test_client.TestGitClientWithAuth object at 0x10a84bf00>
mock_path = <MagicMock name='Path' id='4502439648'>
mock_subprocess = <MagicMock name='run' id='4502446368'>
mock_credentials_manager = <Mock spec='CredentialsManager' id='4502446032'>
ssh_profile = AuthProfile(profile_id='ssh-profile-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, s... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    @patch("agentos.core.git.client.subprocess.run")
    @patch("agentos.core.git.client.Path")
    def test_clone_with_ssh_key(
        self,
        mock_path,
        mock_subprocess,
        mock_credentials_manager,
        ssh_profile,
    ):
        """Test cloning with SSH key"""
        client = GitClientWithAuth(mock_credentials_manager)
    
        # Mock profile retrieval
        mock_credentials_manager.get_profile.return_value = ssh_profile
    
        # Mock subprocess success
        mock_subprocess.return_value = Mock(returncode=0)
    
        # Mock key path existence
        mock_key = Mock()
        mock_key.exists.return_value = True
        mock_path.return_value.expanduser.return_value = mock_key
    
        # Mock dest path
        dest_path = Path("/tmp/test-repo")
    
        # Clone
>       result = client.clone(
            remote_url="git@github.com:user/repo.git",
            dest_path=dest_path,
            auth_profile="test-ssh",
        )

tests/unit/test_git/test_client.py:168: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/core/git/client.py:178: in clone
    return GitClient(dest_path)
           ^^^^^^^^^^^^^^^^^^^^
agentos/core/infra/git_client.py:27: in __init__
    self.repo = Repo(str(repo_path))
                ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'Repo' object has no attribute 'git_dir'") raised in repr()] Repo object at 0x10c4ebbd0>
path = '/tmp/test-repo', odbt = <class 'git.db.GitCmdObjectDB'>
search_parent_directories = False, expand_vars = True

    def __init__(
        self,
        path: Optional[PathLike] = None,
        odbt: Type[LooseObjectDB] = GitCmdObjectDB,
        search_parent_directories: bool = False,
        expand_vars: bool = True,
    ) -> None:
        R"""Create a new :class:`Repo` instance.
    
        :param path:
            The path to either the worktree directory or the .git directory itself::
    
                repo = Repo("/Users/mtrier/Development/git-python")
                repo = Repo("/Users/mtrier/Development/git-python.git")
                repo = Repo("~/Development/git-python.git")
                repo = Repo("$REPOSITORIES/Development/git-python.git")
                repo = Repo(R"C:\Users\mtrier\Development\git-python\.git")
    
            - In *Cygwin*, `path` may be a ``cygdrive/...`` prefixed path.
            - If `path` is ``None`` or an empty string, :envvar:`GIT_DIR` is used. If
              that environment variable is absent or empty, the current directory is
              used.
    
        :param odbt:
            Object DataBase type - a type which is constructed by providing the
            directory containing the database objects, i.e. ``.git/objects``. It will be
            used to access all object data.
    
        :param search_parent_directories:
            If ``True``, all parent directories will be searched for a valid repo as
            well.
    
            Please note that this was the default behaviour in older versions of
            GitPython, which is considered a bug though.
    
        :raise git.exc.InvalidGitRepositoryError:
    
        :raise git.exc.NoSuchPathError:
    
        :return:
            :class:`Repo`
        """
    
        epath = path or os.getenv("GIT_DIR")
        if not epath:
            epath = os.getcwd()
        epath = os.fspath(epath)
        if Git.is_cygwin():
            # Given how the tests are written, this seems more likely to catch Cygwin
            # git used from Windows than Windows git used from Cygwin. Therefore
            # changing to Cygwin-style paths is the relevant operation.
            epath = cygpath(epath)
    
        if expand_vars and re.search(self.re_envvars, epath):
            warnings.warn(
                "The use of environment variables in paths is deprecated"
                + "\nfor security reasons and may be removed in the future!!",
                stacklevel=1,
            )
        epath = expand_path(epath, expand_vars)
        if epath is not None:
            if not os.path.exists(epath):
>               raise NoSuchPathError(epath)
E               git.exc.NoSuchPathError: /tmp/test-repo

.venv/lib/python3.13/site-packages/git/repo/base.py:235: NoSuchPathError
______________ TestGitClientWithAuth.test_clone_with_env_fallback ______________

self = <test_git.test_client.TestGitClientWithAuth object at 0x10a892d50>
mock_subprocess = <MagicMock name='run' id='4502443344'>
mock_credentials_manager = <Mock spec='CredentialsManager' id='4502443008'>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10c4e8d10>

    @patch("agentos.core.git.client.subprocess.run")
    def test_clone_with_env_fallback(
        self,
        mock_subprocess,
        mock_credentials_manager,
        monkeypatch,
    ):
        """Test cloning with environment variable fallback"""
        client = GitClientWithAuth(mock_credentials_manager)
    
        # No auth profile provided
        mock_credentials_manager.get_profile.return_value = None
    
        # Mock env token
        mock_credentials_manager.get_from_env.return_value = "env-token-123"
    
        # Mock subprocess success
        mock_subprocess.return_value = Mock(returncode=0)
    
        # Clone
>       result = client.clone(
            remote_url="https://github.com/user/repo.git",
            dest_path=Path("/tmp/test-repo"),
            auth_profile=None,
        )

tests/unit/test_git/test_client.py:240: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/core/git/client.py:178: in clone
    return GitClient(dest_path)
           ^^^^^^^^^^^^^^^^^^^^
agentos/core/infra/git_client.py:27: in __init__
    self.repo = Repo(str(repo_path))
                ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <[AttributeError("'Repo' object has no attribute 'git_dir'") raised in repr()] Repo object at 0x10c83a250>
path = '/tmp/test-repo', odbt = <class 'git.db.GitCmdObjectDB'>
search_parent_directories = False, expand_vars = True

    def __init__(
        self,
        path: Optional[PathLike] = None,
        odbt: Type[LooseObjectDB] = GitCmdObjectDB,
        search_parent_directories: bool = False,
        expand_vars: bool = True,
    ) -> None:
        R"""Create a new :class:`Repo` instance.
    
        :param path:
            The path to either the worktree directory or the .git directory itself::
    
                repo = Repo("/Users/mtrier/Development/git-python")
                repo = Repo("/Users/mtrier/Development/git-python.git")
                repo = Repo("~/Development/git-python.git")
                repo = Repo("$REPOSITORIES/Development/git-python.git")
                repo = Repo(R"C:\Users\mtrier\Development\git-python\.git")
    
            - In *Cygwin*, `path` may be a ``cygdrive/...`` prefixed path.
            - If `path` is ``None`` or an empty string, :envvar:`GIT_DIR` is used. If
              that environment variable is absent or empty, the current directory is
              used.
    
        :param odbt:
            Object DataBase type - a type which is constructed by providing the
            directory containing the database objects, i.e. ``.git/objects``. It will be
            used to access all object data.
    
        :param search_parent_directories:
            If ``True``, all parent directories will be searched for a valid repo as
            well.
    
            Please note that this was the default behaviour in older versions of
            GitPython, which is considered a bug though.
    
        :raise git.exc.InvalidGitRepositoryError:
    
        :raise git.exc.NoSuchPathError:
    
        :return:
            :class:`Repo`
        """
    
        epath = path or os.getenv("GIT_DIR")
        if not epath:
            epath = os.getcwd()
        epath = os.fspath(epath)
        if Git.is_cygwin():
            # Given how the tests are written, this seems more likely to catch Cygwin
            # git used from Windows than Windows git used from Cygwin. Therefore
            # changing to Cygwin-style paths is the relevant operation.
            epath = cygpath(epath)
    
        if expand_vars and re.search(self.re_envvars, epath):
            warnings.warn(
                "The use of environment variables in paths is deprecated"
                + "\nfor security reasons and may be removed in the future!!",
                stacklevel=1,
            )
        epath = expand_path(epath, expand_vars)
        if epath is not None:
            if not os.path.exists(epath):
>               raise NoSuchPathError(epath)
E               git.exc.NoSuchPathError: /tmp/test-repo

.venv/lib/python3.13/site-packages/git/repo/base.py:235: NoSuchPathError
__________________ TestGitClientWithAuth.test_pull_with_auth ___________________

self = <test_git.test_client.TestGitClientWithAuth object at 0x10a9fb690>
mock_subprocess = <MagicMock name='run' id='4502452752'>
mock_credentials_manager = <Mock spec='CredentialsManager' id='4502448048'>
ssh_profile = AuthProfile(profile_id='ssh-profile-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, s... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    @patch("agentos.core.git.client.subprocess.run")
    def test_pull_with_auth(
        self,
        mock_subprocess,
        mock_credentials_manager,
        ssh_profile,
    ):
        """Test pulling with authentication"""
        client = GitClientWithAuth(mock_credentials_manager)
    
        # Mock profile retrieval
        mock_credentials_manager.get_profile.return_value = ssh_profile
    
        # Mock subprocess success
        mock_subprocess.return_value = Mock(returncode=0)
    
        # Pull
>       client.pull(
            repo_path=Path("/tmp/test-repo"),
            auth_profile="test-ssh",
        )

tests/unit/test_git/test_client.py:358: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/core/git/client.py:228: in pull
    env = self._prepare_ssh_env(profile.ssh_key_path)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.git.client.GitClientWithAuth object at 0x10c8b2e70>
ssh_key_path = '~/.ssh/id_rsa'

    def _prepare_ssh_env(self, ssh_key_path: str) -> dict:
        """Prepare environment variables for SSH authentication
    
        Uses GIT_SSH_COMMAND to specify SSH key.
        """
        env = os.environ.copy()
    
        # Expand home directory
        key_path = Path(ssh_key_path).expanduser()
    
        if not key_path.exists():
>           raise FileNotFoundError(f"SSH key not found: {key_path}")
E           FileNotFoundError: SSH key not found: /Users/pangge/.ssh/id_rsa

agentos/core/git/client.py:86: FileNotFoundError
__________________ TestGitClientWithAuth.test_push_with_auth ___________________

self = <test_git.test_client.TestGitClientWithAuth object at 0x10a9fba10>
mock_subprocess = <MagicMock name='run' id='4502442672'>
mock_credentials_manager = <Mock spec='CredentialsManager' id='4502445360'>
ssh_profile = AuthProfile(profile_id='ssh-profile-id', profile_name='test-ssh', profile_type=<AuthProfileType.SSH_KEY: 'ssh_key'>, s... last_validated_at=None, validation_status=<ValidationStatus.UNKNOWN: 'unknown'>, validation_message=None, metadata={})

    @patch("agentos.core.git.client.subprocess.run")
    def test_push_with_auth(
        self,
        mock_subprocess,
        mock_credentials_manager,
        ssh_profile,
    ):
        """Test pushing with authentication"""
        client = GitClientWithAuth(mock_credentials_manager)
    
        # Mock profile retrieval
        mock_credentials_manager.get_profile.return_value = ssh_profile
    
        # Mock subprocess success
        mock_subprocess.return_value = Mock(returncode=0)
    
        # Push
>       client.push(
            repo_path=Path("/tmp/test-repo"),
            auth_profile="test-ssh",
        )

tests/unit/test_git/test_client.py:391: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agentos/core/git/client.py:300: in push
    env = self._prepare_ssh_env(profile.ssh_key_path)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agentos.core.git.client.GitClientWithAuth object at 0x10c8a1430>
ssh_key_path = '~/.ssh/id_rsa'

    def _prepare_ssh_env(self, ssh_key_path: str) -> dict:
        """Prepare environment variables for SSH authentication
    
        Uses GIT_SSH_COMMAND to specify SSH key.
        """
        env = os.environ.copy()
    
        # Expand home directory
        key_path = Path(ssh_key_path).expanduser()
    
        if not key_path.exists():
>           raise FileNotFoundError(f"SSH key not found: {key_path}")
E           FileNotFoundError: SSH key not found: /Users/pangge/.ssh/id_rsa

agentos/core/git/client.py:86: FileNotFoundError
________________ TestWorkspaceRoot.test_init_with_absolute_path ________________

self = <workspace.test_layout.TestWorkspaceRoot object at 0x10bfdc690>

    def test_init_with_absolute_path(self):
        """Test initialization with absolute path"""
        root = WorkspaceRoot(Path("/tmp/workspace"))
>       assert root.root_path == Path("/tmp/workspace")
E       AssertionError: assert PosixPath('/private/tmp/workspace') == PosixPath('/tmp/workspace')
E        +  where PosixPath('/private/tmp/workspace') = WorkspaceRoot(root_path=PosixPath('/private/tmp/workspace')).root_path
E        +  and   PosixPath('/tmp/workspace') = Path('/tmp/workspace')

tests/unit/workspace/test_layout.py:18: AssertionError
___________________ TestWorkspaceRoot.test_get_projects_dir ____________________

self = <workspace.test_layout.TestWorkspaceRoot object at 0x10b3475c0>

    def test_get_projects_dir(self):
        """Test getting projects directory"""
        root = WorkspaceRoot(Path("/tmp/workspace"))
        projects_dir = root.get_projects_dir()
>       assert projects_dir == Path("/tmp/workspace/projects")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects') == PosixPath('/tmp/workspace/projects')
E        +  where PosixPath('/tmp/workspace/projects') = Path('/tmp/workspace/projects')

tests/unit/workspace/test_layout.py:35: AssertionError
__________________ TestWorkspaceRoot.test_ensure_projects_dir __________________

self = <workspace.test_layout.TestWorkspaceRoot object at 0x10bfcda30>

    def test_ensure_projects_dir(self):
        """Test ensuring projects directory exists"""
        with TemporaryDirectory() as tmpdir:
            root = WorkspaceRoot(Path(tmpdir))
            projects_dir = root.ensure_projects_dir()
    
            assert projects_dir.exists()
            assert projects_dir.is_dir()
>           assert projects_dir == Path(tmpdir) / "projects"
E           AssertionError: assert PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmp9zhri2te/projects') == (PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmp9zhri2te') / 'projects')
E            +  where PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmp9zhri2te') = Path('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmp9zhri2te')

tests/unit/workspace/test_layout.py:45: AssertionError
________________________ TestWorkspaceLayout.test_init _________________________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10bfdca50>

    def test_init(self):
        """Test initialization"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
>       assert layout.workspace_root.root_path == Path("/tmp/workspace")
E       AssertionError: assert PosixPath('/private/tmp/workspace') == PosixPath('/tmp/workspace')
E        +  where PosixPath('/private/tmp/workspace') = WorkspaceRoot(root_path=PosixPath('/private/tmp/workspace')).root_path
E        +    where WorkspaceRoot(root_path=PosixPath('/private/tmp/workspace')) = <agentos.core.workspace.layout.WorkspaceLayout object at 0x10c741310>.workspace_root
E        +  and   PosixPath('/tmp/workspace') = Path('/tmp/workspace')

tests/unit/workspace/test_layout.py:54: AssertionError
__________________ TestWorkspaceLayout.test_get_project_root ___________________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10bfdcb90>

    def test_get_project_root(self):
        """Test getting project root"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
        project_root = layout.get_project_root("my-app")
    
>       assert project_root == Path("/tmp/workspace/projects/my-app")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects/my-app') == PosixPath('/tmp/workspace/projects/my-app')
E        +  where PosixPath('/tmp/workspace/projects/my-app') = Path('/tmp/workspace/projects/my-app')

tests/unit/workspace/test_layout.py:61: AssertionError
____________________ TestWorkspaceLayout.test_get_repo_path ____________________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10b3476f0>

    def test_get_repo_path(self):
        """Test getting repository path"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
    
        repo = RepoSpec(
            repo_id="repo1",
            project_id="my-app",
            name="backend",
            workspace_relpath="./be",
            role=RepoRole.CODE,
        )
    
        repo_path = layout.get_repo_path("my-app", repo)
>       assert repo_path == Path("/tmp/workspace/projects/my-app/be")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects/my-app/be') == PosixPath('/tmp/workspace/projects/my-app/be')
E        +  where PosixPath('/tmp/workspace/projects/my-app/be') = Path('/tmp/workspace/projects/my-app/be')

tests/unit/workspace/test_layout.py:76: AssertionError
__________ TestWorkspaceLayout.test_get_repo_path_with_nested_relpath __________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10b347820>

    def test_get_repo_path_with_nested_relpath(self):
        """Test getting repository path with nested relpath"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
    
        repo = RepoSpec(
            repo_id="repo1",
            project_id="my-app",
            name="api",
            workspace_relpath="./services/api",
            role=RepoRole.CODE,
        )
    
        repo_path = layout.get_repo_path("my-app", repo)
>       assert repo_path == Path("/tmp/workspace/projects/my-app/services/api")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects/my-app/services/api') == PosixPath('/tmp/workspace/projects/my-app/services/api')
E        +  where PosixPath('/tmp/workspace/projects/my-app/services/api') = Path('/tmp/workspace/projects/my-app/services/api')

tests/unit/workspace/test_layout.py:91: AssertionError
__________ TestWorkspaceLayout.test_get_repo_path_with_parent_relpath __________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10bfcc4d0>

    def test_get_repo_path_with_parent_relpath(self):
        """Test getting repository path with parent directory"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
    
        repo = RepoSpec(
            repo_id="repo1",
            project_id="my-app",
            name="shared",
            workspace_relpath="../shared",
            role=RepoRole.CODE,
        )
    
        repo_path = layout.get_repo_path("my-app", repo)
        # Should resolve to /tmp/workspace/projects/shared
>       assert repo_path == Path("/tmp/workspace/projects/shared")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects/shared') == PosixPath('/tmp/workspace/projects/shared')
E        +  where PosixPath('/tmp/workspace/projects/shared') = Path('/tmp/workspace/projects/shared')

tests/unit/workspace/test_layout.py:107: AssertionError
__________________ TestWorkspaceLayout.test_get_metadata_dir ___________________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10b399e10>

    def test_get_metadata_dir(self):
        """Test getting metadata directory"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
        metadata_dir = layout.get_metadata_dir("my-app")
    
>       assert metadata_dir == Path("/tmp/workspace/projects/my-app/.agentos")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects/my-app/.agentos') == PosixPath('/tmp/workspace/projects/my-app/.agentos')
E        +  where PosixPath('/tmp/workspace/projects/my-app/.agentos') = Path('/tmp/workspace/projects/my-app/.agentos')

tests/unit/workspace/test_layout.py:114: AssertionError
_________________ TestWorkspaceLayout.test_ensure_project_root _________________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10b399ae0>

    def test_ensure_project_root(self):
        """Test ensuring project root exists"""
        with TemporaryDirectory() as tmpdir:
            layout = WorkspaceLayout(Path(tmpdir))
            project_root = layout.ensure_project_root("my-app")
    
            assert project_root.exists()
            assert project_root.is_dir()
>           assert project_root == Path(tmpdir) / "projects" / "my-app"
E           AssertionError: assert PosixPath('/private/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmpssxfjmey/projects/my-app') == ((PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmpssxfjmey') / 'projects') / 'my-app')
E            +  where PosixPath('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmpssxfjmey') = Path('/var/folders/cm/cw7cby1x0t52gcdk4_9rg35r0000gn/T/tmpssxfjmey')

tests/unit/workspace/test_layout.py:124: AssertionError
__________________ TestWorkspaceLayout.test_get_path_mapping ___________________

self = <workspace.test_layout.TestWorkspaceLayout object at 0x10b317890>

    def test_get_path_mapping(self):
        """Test getting path mapping for repos"""
        layout = WorkspaceLayout(Path("/tmp/workspace"))
    
        repos = [
            RepoSpec(
                repo_id="repo1",
                project_id="my-app",
                name="backend",
                workspace_relpath="./be",
                role=RepoRole.CODE,
            ),
            RepoSpec(
                repo_id="repo2",
                project_id="my-app",
                name="frontend",
                workspace_relpath="./fe",
                role=RepoRole.CODE,
            ),
        ]
    
        path_mapping = layout.get_path_mapping("my-app", repos)
    
        assert "backend" in path_mapping
        assert "frontend" in path_mapping
>       assert path_mapping["backend"] == Path("/tmp/workspace/projects/my-app/be")
E       AssertionError: assert PosixPath('/private/tmp/workspace/projects/my-app/be') == PosixPath('/tmp/workspace/projects/my-app/be')
E        +  where PosixPath('/tmp/workspace/projects/my-app/be') = Path('/tmp/workspace/projects/my-app/be')

tests/unit/workspace/test_layout.py:213: AssertionError
=============================== warnings summary ===============================
tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_empty_stats
tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_decision_type_distribution
tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_time_window_filtering
tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_non_supervisor_events_excluded
tests/unit/governance/test_governance_stats.py::TestOverallStats::test_overall_stats_empty
tests/unit/governance/test_governance_stats.py::TestOverallStats::test_overall_stats_comprehensive
  /Users/pangge/PycharmProjects/AgentOS/agentos/core/supervisor/trace/stats.py:55: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    cutoff_time = datetime.utcnow() - timedelta(hours=hours)

tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_decision_type_distribution
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:67: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_time_window_filtering
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:99: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestDecisionTypeStats::test_non_supervisor_events_excluded
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:130: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestBlockedTasksTopN::test_blocked_tasks_ranking
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:170: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestBlockedTasksTopN::test_blocked_tasks_limit
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:221: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestBlockedTasksTopN::test_blocked_tasks_with_reason_code
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:243: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_empty_lag_data
tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_lag_calculation
tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_lag_ignore_negative_values
tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_lag_time_window
tests/unit/governance/test_governance_stats.py::TestOverallStats::test_overall_stats_empty
tests/unit/governance/test_governance_stats.py::TestOverallStats::test_overall_stats_comprehensive
  /Users/pangge/PycharmProjects/AgentOS/agentos/core/supervisor/trace/stats.py:148: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    cutoff_time = datetime.utcnow() - timedelta(hours=hours)

tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_lag_calculation
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:289: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_lag_ignore_negative_values
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:331: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestDecisionLagPercentiles::test_lag_time_window
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:384: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/governance/test_governance_stats.py::TestOverallStats::test_overall_stats_comprehensive
  /Users/pangge/PycharmProjects/AgentOS/tests/unit/governance/test_governance_stats.py:453: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/project/test_compat.py::TestSingleRepoCompatAdapter::test_get_absolute_path_with_relpath
  /Users/pangge/PycharmProjects/AgentOS/agentos/core/project/compat.py:153: DeprecationWarning: Project 'proj-002' has 2 repositories. Using get_default_repo() for multi-repo projects is deprecated. Consider explicit repository access via get_repo_by_name() or iterate over repos.
    default_repo = self.project.get_default_repo()

tests/unit/task/test_artifact_service.py: 12 warnings
tests/unit/task/test_dependency_service.py: 2 warnings
  /Users/pangge/PycharmProjects/AgentOS/agentos/core/task/artifact_service.py:87: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "created_at": self.created_at or datetime.utcnow().isoformat(),

tests/unit/task/test_audit_service.py::TestTaskAudit::test_to_db_dict
tests/unit/task/test_audit_service.py::TestTaskAuditService::test_record_operation
tests/unit/task/test_audit_service.py::TestTaskAuditService::test_record_operation_task_level
tests/unit/task/test_audit_service.py::TestTaskAuditService::test_record_operation_with_error
tests/unit/task/test_audit_service.py::TestTaskAuditService::test_record_git_changes
tests/unit/task/test_dependency_service.py::test_detect_file_dependencies
tests/unit/task/test_dependency_service.py::test_detect_file_dependencies
  /Users/pangge/PycharmProjects/AgentOS/agentos/core/task/audit_service.py:126: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "created_at": self.created_at or datetime.utcnow().isoformat(),

tests/unit/task/test_dependency_service.py: 36 warnings
  /Users/pangge/PycharmProjects/AgentOS/agentos/core/task/dependency_service.py:647: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow().isoformat(),

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e96c0>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e9b70>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e9a80>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e9f30>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea3e0>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea4d0>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea7a0>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e9300>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea020>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea110>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea6b0>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea200>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6eaa70>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea2f0>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6eac50>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_runner_audit_integration.py::TestTaskRunnerAuditor::test_record_completion_failed
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:479: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea980>
    @staticmethod
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c030400>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c0318a0>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6eae30>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e97b0>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ea890>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6eab60>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6e8b80>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/task/test_task_api_enforces_state_machine.py::test_create_task_starts_in_draft
  /opt/homebrew/Cellar/python@3.13/3.13.11/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:112: ResourceWarning: unclosed database in <sqlite3.Connection object at 0x10c6ead40>
    doc = getattr(func, "__doc__", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.13.11-final-0 _______________

Name                                                      Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------------------
agentos/__init__.py                                           1      0   100%
agentos/adapters/__init__.py                                  7      7     0%   3-19
agentos/adapters/base.py                                     17     17     0%   3-51
agentos/adapters/dotnet.py                                   45     45     0%   3-136
agentos/adapters/vite_react.py                               76     76     0%   3-190
agentos/cli/__init__.py                                       0      0   100%
agentos/cli/answers.py                                      154    154     0%   3-298
agentos/cli/auth.py                                         169    169     0%   3-320
agentos/cli/commands/project_trace.py                       163     40    75%   57, 77-78, 201, 208-224, 230, 272-300, 344, 378, 387, 393-395, 399
agentos/cli/commands/task_trace.py                          189     57    70%   42, 49, 55, 57, 60-65, 190-217, 245, 254, 286-326, 380, 447, 453-455, 459
agentos/cli/content.py                                      407    407     0%   3-609
agentos/cli/coordinate.py                                   103    103     0%   3-170
agentos/cli/dry_executor.py                                 180    180     0%   7-282
agentos/cli/evaluator.py                                    103    103     0%   5-145
agentos/cli/executor.py                                     149    149     0%   3-250
agentos/cli/generate.py                                      81     81     0%   3-137
agentos/cli/health.py                                        27     27     0%   3-65
agentos/cli/init.py                                          12     12     0%   3-19
agentos/cli/intent_builder.py                               215    215     0%   3-327
agentos/cli/interactive.py                                  366    366     0%   3-597
agentos/cli/kb.py                                           398    398     0%   10-686
agentos/cli/main.py                                         110    110     0%   3-146
agentos/cli/memory.py                                       336    336     0%   3-587
agentos/cli/migrate.py                                       34     34     0%   3-77
agentos/cli/orchestrate.py                                    7      7     0%   3-13
agentos/cli/pipeline.py                                      63     63     0%   3-105
agentos/cli/project.py                                      772    483    37%   29, 44-74, 80-105, 226-227, 262, 315-317, 335-354, 409-413, 417-418, 425-427, 436-437, 448, 502-503, 508-511, 518-521, 536-537, 542-546, 548-549, 561-568, 573-576, 582-731, 744-748, 759, 778-780, 792-794, 805, 816-821, 860-861, 884-886, 907-908, 912-915, 923-927, 960-961, 967, 971, 973, 981-985, 1019-1153, 1164, 1178-1245, 1264-1370, 1401-1546
agentos/cli/project_migrate.py                              165    165     0%   7-346
agentos/cli/replay.py                                        11     11     0%   3-19
agentos/cli/run.py                                          106    106     0%   7-229
agentos/cli/scan.py                                          64     64     0%   3-111
agentos/cli/task.py                                         176    176     0%   3-336
agentos/cli/tools.py                                        200    200     0%   3-359
agentos/cli/verify.py                                        23     23     0%   3-34
agentos/cli/web.py                                           34     34     0%   7-100
agentos/cli/webui_control.py                                101    101     0%   11-203
agentos/common/__init__.py                                    2      0   100%
agentos/common/reasons.py                                    30      0   100%
agentos/config/__init__.py                                    3      0   100%
agentos/config/cli_settings.py                               99     59    40%   46, 50, 54, 58, 62, 67, 86-93, 97-106, 110-115, 119-121, 125-127, 136-138, 142-145, 154-156, 168-170, 182-189, 199-201, 206, 211
agentos/config/loader.py                                     45      0   100%
agentos/context/__init__.py                                   2      2     0%   13-15
agentos/context/manager.py                                  161    161     0%   13-374
agentos/core/__init__.py                                      3      0   100%
agentos/core/answers/__init__.py                              4      4     0%   8-12
agentos/core/answers/answer_applier.py                       74     74     0%   7-276
agentos/core/answers/answer_store.py                         52     52     0%   6-162
agentos/core/answers/answer_validator.py                    106    106     0%   10-287
agentos/core/answers/llm_suggester.py                       140    140     0%   3-350
agentos/core/answers/multiround.py                          132    132     0%   3-437
agentos/core/audit.py                                        79     57    28%   118-170, 187-214, 244-300, 320, 334, 348
agentos/core/capability_registry.py                         104     46    56%   51-61, 84, 88, 92, 122-133, 148-149, 154-183, 207, 230, 294, 318, 350-353, 365, 369, 382-390, 414-431, 446-448
agentos/core/chat/__init__.py                                 3      0   100%
agentos/core/chat/adapters.py                               277    277     0%   3-521
agentos/core/chat/commands.py                                56     29    48%   21, 53-55, 73-81, 85, 89, 98, 113-136
agentos/core/chat/context_builder.py                        329    329     0%   3-936
agentos/core/chat/context_diff.py                           126    126     0%   3-429
agentos/core/chat/engine.py                                 106    106     0%   3-354
agentos/core/chat/export.py                                  74     60    19%   30-97, 115-128, 140-141, 156-160
agentos/core/chat/handlers/__init__.py                        8      0   100%
agentos/core/chat/handlers/context_handler.py               131    121     8%   22-47, 57-152, 157-204, 214-289, 294-295
agentos/core/chat/handlers/export_handler.py                 46     36    22%   22-81, 86-87
agentos/core/chat/handlers/extract_handler.py                43     36    16%   19-89, 94-95
agentos/core/chat/handlers/model_handler.py                  27     20    26%   19-51, 56-57
agentos/core/chat/handlers/stream_handler.py                 32     25    22%   19-59, 64-65
agentos/core/chat/handlers/summary_handler.py                37     30    19%   19-66, 71-72
agentos/core/chat/handlers/task_handler.py                   94     69    27%   43-44, 58-167, 186-187
agentos/core/chat/models.py                                  34      5    85%   33, 56, 67, 78, 86
agentos/core/chat/rendering.py                               56     56     0%   3-128
agentos/core/chat/service.py                                152     96    37%   93-96, 122, 145-172, 185-214, 227-248, 256-273, 297-338, 352-367, 385-412, 428-448, 459-471
agentos/core/chat/summarizer.py                             138    138     0%   3-441
agentos/core/chat/workflow.py                                65      3    95%   246, 248-249
agentos/core/command/__init__.py                              4      0   100%
agentos/core/command/handler.py                              12      3    75%   28, 39, 47
agentos/core/command/handlers/__init__.py                     4      4     0%   3-7
agentos/core/command/handlers/history_handlers.py            95     95     0%   3-236
agentos/core/command/handlers/kb_handlers.py                112    112     0%   3-374
agentos/core/command/handlers/mem_handlers.py               114    114     0%   3-305
agentos/core/command/handlers/model_commands.py              58     58     0%   3-204
agentos/core/command/history.py                             116     66    43%   33, 64-69, 137-151, 182-207, 233-250, 258-267, 275-289, 311-326, 334-343
agentos/core/command/registry.py                             76     15    80%   58-59, 67-68, 87, 141, 145, 170-180, 211-213, 223
agentos/core/command/types.py                                67      5    93%   56, 58, 60, 93, 101
agentos/core/content/__init__.py                              7      7     0%   10-18
agentos/core/content/activation.py                           70     70     0%   6-216
agentos/core/content/facade.py                               98     98     0%   7-303
agentos/core/content/lineage.py                              96     96     0%   3-280
agentos/core/content/registry.py                            123    123     0%   7-362
agentos/core/content/schema_loader.py                        58     58     0%   3-143
agentos/core/content/types.py                                66     66     0%   3-266
agentos/core/coordinator/__init__.py                          9      9     0%   3-22
agentos/core/coordinator/engine.py                          102    102     0%   7-245
agentos/core/coordinator/graph_builder.py                    52     52     0%   3-140
agentos/core/coordinator/intent_parser.py                    24     24     0%   4-56
agentos/core/coordinator/model_router.py                     15     15     0%   4-43
agentos/core/coordinator/output_freezer.py                   31     31     0%   3-67
agentos/core/coordinator/question_governor.py                26     26     0%   4-75
agentos/core/coordinator/rules_adjudicator.py                24     24     0%   4-65
agentos/core/evaluator/__init__.py                            9      0   100%
agentos/core/evaluator/conflict_detector.py                 149    133    11%   28-35, 39-47, 51, 67, 79-103, 124-163, 185-215, 236-258, 280-309, 329-378, 399-453, 470-486
agentos/core/evaluator/engine.py                             93     70    25%   31-59, 63, 70-73, 77-80, 84, 95-101, 107, 131-135, 156-212, 229-231, 269-301
agentos/core/evaluator/evaluation_explainer.py              109    104     5%   88-204, 216-234
agentos/core/evaluator/intent_normalizer.py                  54     42    22%   21-36, 45-60, 69-80, 89-90, 112-137, 141, 153, 169-170, 182
agentos/core/evaluator/intent_set_loader.py                  83     72    13%   24, 43-72, 92-108, 122-151, 167-213
agentos/core/evaluator/merge_planner.py                     146    125    14%   29-34, 38-48, 55-59, 63, 67-68, 72, 83, 102-118, 134-156, 174-214, 230-257, 276-344, 362-375
agentos/core/evaluator/risk_comparator.py                    85     68    20%   15-17, 21, 29, 37, 41, 79-109, 121-130, 142-159, 171-180, 192-201, 220-234
agentos/core/events/__init__.py                               3      0   100%
agentos/core/events/bus.py                                   73     41    44%   42-47, 55-57, 65-67, 71-77, 90-93, 97-100, 108-120, 124-127, 131, 154
agentos/core/events/types.py                                 72     14    81%   62, 81, 92, 101, 110, 119, 139, 148, 157, 166, 185, 205, 225, 246
agentos/core/executor/__init__.py                             8      0   100%
agentos/core/executor/allowlist.py                           71     46    35%   27-95, 113-127, 131-138, 142-148, 152-162, 166-168, 172, 176, 182, 191, 200, 211, 219, 231-235, 244, 252
agentos/core/executor/async_engine.py                       105    105     0%   7-289
agentos/core/executor/audit_logger.py                        54     40    26%   19-26, 46-68, 72, 90-94, 104, 112, 122-136, 140-144
agentos/core/executor/container_sandbox.py                   65     65     0%   3-202
agentos/core/executor/dag_scheduler.py                      143    143     0%   3-316
agentos/core/executor/executor_engine.py                    314    283    10%   37-39, 63-74, 93-467, 486-521, 530-537, 545-550, 557-566, 572-583, 634-770, 799-942, 965-984, 1018-1036, 1050-1068
agentos/core/executor/lock.py                                64     50    22%   19-23, 37-71, 75-79, 83-94, 98-111, 115-124, 128, 132
agentos/core/executor/model_selector.py                      33     33     0%   10-94
agentos/core/executor/open_plan_verifier.py                 147    147     0%   27-431
agentos/core/executor/review_gate.py                         63     51    19%   18-19, 31, 50-66, 78-90, 109-127, 146-163, 167-176
agentos/core/executor/rollback.py                            79     63    20%   21-23, 42-68, 85-127, 135-155, 164-170, 184-195, 199-203, 207, 211
agentos/core/executor/run_tape.py                            75     56    25%   28-36, 47-49, 76-93, 102, 106, 115-135, 145-155, 167-173, 177-183, 192-201, 213-214, 227
agentos/core/executor/sandbox.py                             50     36    28%   26-32, 45-59, 63-79, 83, 87-94, 98, 107, 111
agentos/core/executor/sandbox_policy.py                      73     51    30%   25-28, 41-46, 58-59, 75-94, 111-119, 123, 127, 131, 135, 148-149, 153, 157-161, 177-186, 198-202, 215-216
agentos/core/executor_dry/__init__.py                         8      8     0%   17-35
agentos/core/executor_dry/commit_planner.py                 123    123     0%   7-295
agentos/core/executor_dry/dry_executor.py                    46     46     0%   7-192
agentos/core/executor_dry/graph_builder.py                   86     86     0%   8-250
agentos/core/executor_dry/open_plan_builder.py               56     56     0%   9-323
agentos/core/executor_dry/patch_planner.py                   90     90     0%   8-247
agentos/core/executor_dry/review_pack_stub.py                80     80     0%   8-193
agentos/core/executor_dry/utils.py                           51     51     0%   5-145
agentos/core/executor_dry/validator.py                       69     69     0%   20-260
agentos/core/gates/__init__.py                                0      0   100%
agentos/core/gates/pause_gate.py                             45     22    51%   36, 49-54, 59-64, 88-89, 109-120, 140-142
agentos/core/gates/runtime_enforcer.py                       42     26    38%   41-75, 96-97, 121-122, 156-162, 185-187
agentos/core/gates/validate_agent_redlines.py                98     84    14%   67, 78-110, 132-148, 170-186, 208-224, 247-279, 302-342, 356-359
agentos/core/gates/validate_command_redlines.py              73     64    12%   28, 42-46, 65-95, 116-141, 161-210, 229-269
agentos/core/gates/validate_rule_redlines.py                 95     85    11%   30, 44-49, 67-94, 112-136, 155-214, 233-262, 281-321
agentos/core/generator/__init__.py                            2      2     0%   3-5
agentos/core/generator/agent_spec_builder.py                 33     33     0%   3-71
agentos/core/generator/question.py                           37     37     0%   3-128
agentos/core/generators/__init__.py                           4      4     0%   6-16
agentos/core/generators/landing_page.py                      35     35     0%   9-256
agentos/core/generators/landing_page_plan.py                 44     44     0%   6-132
agentos/core/generators/template_renderer.py                 23     23     0%   6-144
agentos/core/git/__init__.py                                  5      0   100%
agentos/core/git/client.py                                  293     61    79%   117, 123, 140-142, 215, 221, 234-266, 287, 293, 303-335, 353, 366, 375, 525-538, 564-572, 645, 675, 692, 720, 739-756
agentos/core/git/credentials.py                             174     21    88%   153-157, 252-255, 310-324, 348-350, 461-462
agentos/core/git/guard_rails.py                             113      5    96%   102-104, 250, 333
agentos/core/git/ignore.py                                  100      7    93%   160, 184, 212-213, 218-219, 333
agentos/core/governance/__init__.py                           2      0   100%
agentos/core/governance/guardian/__init__.py                  5      0   100%
agentos/core/governance/guardian/base.py                     10      2    80%   66, 69
agentos/core/governance/guardian/models.py                   47      0   100%
agentos/core/governance/guardian/registry.py                 28      0   100%
agentos/core/governance/guardian/smoke_test_guardian.py      17      9    47%   41-74
agentos/core/governance/orchestration/__init__.py             3      0   100%
agentos/core/governance/orchestration/assigner.py            30      0   100%
agentos/core/governance/orchestration/consumer.py            56     41    27%   42-43, 55-97, 113-122, 135-146, 159-169, 187-217
agentos/core/governance/states.py                             8      0   100%
agentos/core/healing/__init__.py                              2      2     0%   3-5
agentos/core/healing/actions.py                              23     23     0%   3-43
agentos/core/infra/__init__.py                                2      0   100%
agentos/core/infra/container_client.py                       65     65     0%   7-199
agentos/core/infra/credentials_manager.py                    42     42     0%   14-109
agentos/core/infra/git_client.py                            100     61    39%   31-33, 42-45, 49, 61-62, 80-83, 95-97, 109-115, 129-140, 150, 154, 166-175, 184, 197-198, 209-212, 237-240, 244, 254-262, 266, 270, 280-283, 293-299, 318-323
agentos/core/infra/tool_executor.py                          15     15     0%   7-66
agentos/core/intent_builder/__init__.py                       6      6     0%   10-16
agentos/core/intent_builder/builder.py                      179    179     0%   10-571
agentos/core/intent_builder/evidence.py                      75     75     0%   9-207
agentos/core/intent_builder/nl_parser.py                     95     95     0%   3-235
agentos/core/intent_builder/questions.py                     65     65     0%   6-239
agentos/core/intent_builder/registry_query.py               115    115     0%   6-264
agentos/core/lead/__init__.py                                 3      0   100%
agentos/core/lead/adapters/__init__.py                        2      0   100%
agentos/core/lead/adapters/storage.py                       249     42    83%   123, 136-138, 302, 322-324, 416-417, 439-441, 457-491, 613-614, 676, 694-696
agentos/core/lead/adapters/task_creator.py                  117     92    21%   21-26, 80-159, 179-197, 209, 223-249, 262-304, 310-366, 378-383
agentos/core/lead/contract/__init__.py                        2      0   100%
agentos/core/lead/contract/mapper.py                         62      0   100%
agentos/core/lead/dedupe.py                                 133    100    25%   64, 80, 133-200, 216-244, 261-284, 303-329, 346-381, 396-443
agentos/core/lead/miner.py                                  135      0   100%
agentos/core/lead/models.py                                  78      0   100%
agentos/core/lead/service.py                                120     56    53%   183, 216-299, 320-352, 373-404
agentos/core/learning/__init__.py                             2      2     0%   3-5
agentos/core/learning/pipeline.py                             8      8     0%   3-19
agentos/core/llm/__init__.py                                  2      2     0%   3-5
agentos/core/llm/openai_client.py                            24     24     0%   3-105
agentos/core/locks/__init__.py                                5      5     0%   3-8
agentos/core/locks/exceptions.py                             13     13     0%   3-37
agentos/core/locks/file_lock.py                             140    140     0%   3-433
agentos/core/locks/lock_token.py                             10     10     0%   3-19
agentos/core/locks/task_lock.py                             125    125     0%   3-376
agentos/core/memory/__init__.py                               2      0   100%
agentos/core/memory/budgeter.py                              86     69    20%   18-21, 50, 64, 79-89, 106-156, 170-189, 201-208, 220-249
agentos/core/memory/compactor.py                             98     98     0%   3-333
agentos/core/memory/decay.py                                 74     65    12%   32-35, 56-77, 99-137, 154-172, 189-198
agentos/core/memory/deduplicator.py                          97     87    10%   23-26, 41-55, 76-103, 125-199, 216-242, 254-266
agentos/core/memory/promotion.py                             83     71    14%   25, 42-71, 92-137, 158-189, 201-225
agentos/core/memory/service.py                              133    113    15%   24-27, 31-33, 45-101, 105-115, 138-171, 187-210, 233-305, 309-318, 322
agentos/core/mode/__init__.py                                 5      0   100%
agentos/core/mode/mode.py                                    26     12    54%   22-25, 44, 52, 62-64, 118-120
agentos/core/mode/mode_proposer.py                           45     25    44%   83-88, 115-185, 194-199, 243-258, 278-279
agentos/core/mode/mode_selector.py                           24      0   100%
agentos/core/mode/pipeline_runner.py                         92     58    37%   62-64, 79-81, 117-234, 259-315, 344-355
agentos/core/model/__init__.py                                3      3     0%   3-11
agentos/core/model/model_invoker.py                          60     60     0%   11-196
agentos/core/model/model_registry.py                        211    211     0%   12-507
agentos/core/orchestrator/__init__.py                         2      2     0%   3-5
agentos/core/orchestrator/patch_tracker.py                   59     59     0%   3-171
agentos/core/orchestrator/rebase.py                         156    156     0%   3-457
agentos/core/orchestrator/run.py                            128    128     0%   3-229
agentos/core/policy/__init__.py                               3      0   100%
agentos/core/policy/evolution.py                             13     13     0%   3-38
agentos/core/policy/execution_policy.py                     102     67    34%   42-52, 63-65, 80-85, 104-125, 129-134, 148-159, 171-173, 177-185, 198-219, 223, 242-252
agentos/core/policy/risk_profiles.py                          5      2    60%   44, 49
agentos/core/project/__init__.py                              3      0   100%
agentos/core/project/compat.py                              106     14    87%   100, 121, 131, 142, 156-158, 197, 370-371, 376-379
agentos/core/project/repository.py                          153      5    97%   331, 424, 462, 470, 474
agentos/core/project_kb/__init__.py                           3      3     0%   12-20
agentos/core/project_kb/chunker.py                           96     96     0%   10-229
agentos/core/project_kb/config.py                            46     46     0%   10-161
agentos/core/project_kb/embedding/__init__.py                 4      4     0%   8-12
agentos/core/project_kb/embedding/factory.py                 12     12     0%   6-40
agentos/core/project_kb/embedding/local_provider.py          24     24     0%   8-80
agentos/core/project_kb/embedding/manager.py                117    117     0%   10-298
agentos/core/project_kb/embedding/provider.py                17     17     0%   6-48
agentos/core/project_kb/evaluator.py                         73     73     0%   3-176
agentos/core/project_kb/explainer.py                         55     55     0%   9-133
agentos/core/project_kb/indexer.py                          173    173     0%   15-612
agentos/core/project_kb/reranker.py                          57     57     0%   9-154
agentos/core/project_kb/scanner.py                           77     77     0%   10-215
agentos/core/project_kb/searcher.py                          84     84     0%   10-286
agentos/core/project_kb/service.py                          157    157     0%   13-411
agentos/core/project_kb/types.py                            102    102     0%   6-164
agentos/core/review/__init__.py                               2      2     0%   3-5
agentos/core/review/pack_generator.py                       118    118     0%   3-282
agentos/core/runner/__init__.py                               2      2     0%   3-5
agentos/core/runner/task_runner.py                          286    286     0%   10-697
agentos/core/scanner/__init__.py                              2      2     0%   3-5
agentos/core/scanner/pipeline.py                             83     83     0%   3-144
agentos/core/scheduler/__init__.py                            5      5     0%   3-8
agentos/core/scheduler/audit.py                              37     37     0%   3-110
agentos/core/scheduler/node_types.py                         16     16     0%   3-28
agentos/core/scheduler/resource_aware.py                     54     54     0%   3-155
agentos/core/scheduler/scheduler.py                         158    158     0%   3-353
agentos/core/scheduler/task_graph.py                         93     93     0%   3-254
agentos/core/schemas/__init__.py                              4      0   100%
agentos/core/schemas/action_validators.py                    80     65    19%   21-22, 94-174, 188-203, 216, 221, 231-255
agentos/core/schemas/open_plan.py                           112     56    50%   34, 43, 72, 79, 103, 113, 134, 142, 170, 180, 190, 195-196, 204-205, 226-283
agentos/core/schemas/structural_validator.py                 64     46    28%   28, 60, 72-128, 145-149, 165-169, 187-188
agentos/core/status_store.py                                 99     99     0%   12-237
agentos/core/supervisor/__init__.py                           2      0   100%
agentos/core/supervisor/adapters/__init__.py                  4      0   100%
agentos/core/supervisor/adapters/audit_adapter.py            70     49    30%   45-46, 66-89, 116-122, 151-188, 207-253, 265-272
agentos/core/supervisor/adapters/evaluator_adapter.py        51     37    27%   29-33, 50-56, 68-74, 86-92, 104-116, 128-132
agentos/core/supervisor/adapters/gate_adapter.py             63     44    30%   39-44, 65-86, 99, 111-115, 127-131, 143-147, 174-191, 208-219
agentos/core/supervisor/audit_schema.py                     121     16    87%   125, 134, 137, 140, 145, 150, 152, 156, 161, 166, 178, 185, 189, 193, 210, 216
agentos/core/supervisor/inbox.py                             73      4    95%   91-92, 169-170
agentos/core/supervisor/models.py                            66      0   100%
agentos/core/supervisor/policies/__init__.py                  5      5     0%   12-17
agentos/core/supervisor/policies/base.py                     46     46     0%   7-166
agentos/core/supervisor/policies/on_step_completed.py        57     57     0%   7-180
agentos/core/supervisor/policies/on_task_created.py          57     57     0%   7-212
agentos/core/supervisor/policies/on_task_failed.py           54     54     0%   7-223
agentos/core/supervisor/poller.py                            79     17    78%   95-103, 113-122, 210-218
agentos/core/supervisor/router.py                            53      0   100%
agentos/core/supervisor/subscriber.py                        36      1    97%   92
agentos/core/supervisor/supervisor.py                       139    111    20%   46-55, 59-66, 70-82, 91-92, 96-115, 146-151, 160-204, 214-253, 265-275, 279, 290, 304, 325-326, 336-337, 352-365
agentos/core/supervisor/trace/__init__.py                     4      0   100%
agentos/core/supervisor/trace/replay.py                      87     22    75%   166-177, 248-259, 272-295
agentos/core/supervisor/trace/stats.py                       71      5    93%   176-178, 279, 287-288
agentos/core/supervisor/trace/storage.py                     65     13    80%   156-182, 201-222, 284
agentos/core/task/__init__.py                                12      0   100%
agentos/core/task/artifact_service.py                       110      7    94%   98-99, 333-336, 395
agentos/core/task/audit_service.py                          160     31    81%   98, 137-138, 384-385, 395-400, 421-422, 428-439, 443-448, 501-502
agentos/core/task/dependency_service.py                     266     18    93%   90-92, 146, 157, 175, 203, 436, 441-444, 566-569, 638, 841-844
agentos/core/task/errors.py                                  28      1    96%   117
agentos/core/task/lineage_extensions.py                      99     99     0%   3-330
agentos/core/task/manager.py                                197     99    50%   12-18, 85-87, 91, 122, 197-207, 235-236, 240-241, 245-246, 250-251, 289-350, 368-388, 397-419, 473-495, 507-534
agentos/core/task/manager_extended.py                        89     89     0%   3-260
agentos/core/task/models.py                                 146     24    84%   37, 41, 45, 49, 53, 57-76, 89, 111, 115, 139, 143, 147, 151-152, 156
agentos/core/task/path_filter.py                            102      5    95%   64, 160, 231-234
agentos/core/task/repo_context.py                           144     21    85%   71, 104, 196-198, 211, 228-233, 242, 250, 303-305, 350, 423-425, 453
agentos/core/task/rollback.py                                99     13    87%   31-36, 198, 255, 399, 455-456, 462-463
agentos/core/task/routing_service.py                         69     45    35%   98-99, 110, 130-175, 197-236, 248-257, 274-282
agentos/core/task/run_mode.py                                57     25    56%   18, 22-30, 44-45, 49, 59, 69, 91-100, 105-115
agentos/core/task/runner_audit_integration.py                62      3    95%   154-156
agentos/core/task/runner_integration.py                     101    101     0%   40-412
agentos/core/task/service.py                                 94     12    87%   25-30, 546, 568, 597, 601, 605, 615
agentos/core/task/state_machine.py                          100     21    79%   83, 98-109, 127-128, 283-286, 305-306, 370-373
agentos/core/task/states.py                                  33      9    73%   42, 46, 50, 104-108, 124
agentos/core/task/task_repo_service.py                      126      5    96%   281, 293, 300, 367-368
agentos/core/task/trace_builder.py                          100     83    17%   43-61, 74-88, 93-109, 113-126, 131-141, 145-160, 165, 170-182
agentos/core/verify/__init__.py                               5      5     0%   3-12
agentos/core/verify/md_linter.py                             45     45     0%   3-130
agentos/core/verify/md_renderer.py                           15     15     0%   3-44
agentos/core/verify/rule_engine.py                           49     49     0%   3-112
agentos/core/verify/schema_validator.py                     137    137     0%   3-231
agentos/core/verify/schema_validator_service.py              79     79     0%   43-247
agentos/core/workspace/__init__.py                            3      0   100%
agentos/core/workspace/layout.py                            102     10    90%   221-223, 258-259, 325-326, 348-357
agentos/core/workspace/validation.py                        205     29    86%   87-88, 142-144, 176-177, 214, 226-228, 291-293, 315-316, 354-356, 378-395, 423, 433, 438, 443, 448, 507, 510
agentos/ext/__init__.py                                       0      0   100%
agentos/ext/tools/__init__.py                                14     14     0%   21-50
agentos/ext/tools/adapter_registry.py                        64     64     0%   3-189
agentos/ext/tools/base_adapter.py                            30     30     0%   12-141
agentos/ext/tools/claude_cli_adapter.py                     139    139     0%   10-530
agentos/ext/tools/cloud_chat_adapter.py                      74     74     0%   16-296
agentos/ext/tools/codex_adapter.py                           48     48     0%   3-199
agentos/ext/tools/cost_optimizer.py                          79     79     0%   3-242
agentos/ext/tools/diff_verifier.py                           83     83     0%   10-215
agentos/ext/tools/evidence.py                               109    109     0%   19-396
agentos/ext/tools/generic_local_http_adapter.py             119    119     0%   14-407
agentos/ext/tools/llamacpp_adapter.py                        18     18     0%   21-110
agentos/ext/tools/lmstudio_adapter.py                        38     38     0%   16-123
agentos/ext/tools/ollama_adapter.py                          96     96     0%   17-351
agentos/ext/tools/openai_chat_adapter.py                     41     41     0%   18-141
agentos/ext/tools/opencode_adapter.py                        31     31     0%   5-130
agentos/ext/tools/retry_policy.py                            66     66     0%   3-185
agentos/ext/tools/types.py                                   82     82     0%   7-217
agentos/i18n/__init__.py                                      2      2     0%   3-12
agentos/i18n/locale_manager.py                               66     66     0%   3-175
agentos/jobs/__init__.py                                      3      0   100%
agentos/jobs/lead_scan.py                                   249    113    55%   317-366, 390, 396-400, 445-464, 510-526, 543-574, 578-586, 595, 600, 605-691, 695
agentos/jobs/memory_gc.py                                   152    127    16%   49-64, 82-144, 148-159, 163-187, 191-209, 213-245, 249-283, 287-289, 293, 311, 319, 346, 353-373
agentos/pipeline/__init__.py                                 70     70     0%   6-188
agentos/pipeline/resume.py                                    4      4     0%   6-12
agentos/providers/__init__.py                                 3      0   100%
agentos/providers/base.py                                    64      8    88%   55-56, 83, 92, 96, 129-132
agentos/providers/cloud_anthropic.py                        102     64    37%   51-54, 60, 70, 102-248, 257-296
agentos/providers/cloud_config.py                           104     53    49%   69-70, 75-76, 82-84, 92-107, 119-134, 148-164, 172-177, 181, 185-187, 198-207, 215-219
agentos/providers/cloud_openai.py                            98     60    39%   51-54, 60, 70, 101-203, 211-245
agentos/providers/detector.py                               121    121     0%   5-212
agentos/providers/fingerprint.py                            107     51    52%   47-51, 74, 86-100, 109-125, 145-167, 195, 205-210, 231, 233
agentos/providers/local_llamacpp.py                          77     47    39%   48-53, 89-169, 173-210
agentos/providers/local_lmstudio.py                          62     41    34%   48-53, 69-150, 154-177
agentos/providers/local_ollama.py                            61     40    34%   49-54, 71-150, 154-177
agentos/providers/ollama_controller.py                      136    136     0%   20-400
agentos/providers/process_manager.py                        264    264     0%   15-541
agentos/providers/providers_config.py                       126     60    52%   114-117, 123-125, 129-141, 156-157, 176-178, 202-232, 243, 253-268, 272-276
agentos/providers/registry.py                                94     21    78%   45, 49, 65-67, 74-76, 89, 140-144, 147-148, 152-153, 158-159, 172-173, 189-190, 201-202
agentos/providers/runtime.py                                136    136     0%   12-310
agentos/router/__init__.py                                    8      0   100%
agentos/router/events.py                                     37     28    24%   26-41, 53-65, 75-93, 111-127
agentos/router/example.py                                    86     86     0%   9-220
agentos/router/instance_profiles.py                          52     10    81%   58-59, 136-149
agentos/router/models.py                                     96     22    77%   45, 68-71, 114, 148-155, 163-169, 198-199, 203-205
agentos/router/persistence.py                                84     68    19%   35, 39-44, 55-91, 103-131, 142-165, 178-202, 211-250
agentos/router/requirements_extractor.py                     51      7    86%   72, 74, 77, 109-110, 115, 117
agentos/router/router.py                                     65     32    51%   95, 105, 149-218, 239-254, 263-265
agentos/router/scorer.py                                     97     19    80%   34, 168-169, 172, 195-198, 212, 226-231, 235, 255-262
agentos/schemas/__init__.py                                   2      0   100%
agentos/schemas/project.py                                  127     32    75%   51-52, 60, 65, 126-131, 137-142, 190-193, 204-207, 215, 247, 260-261, 272, 285-286, 297
agentos/selfcheck/__init__.py                                 2      2     0%   13-15
agentos/selfcheck/runner.py                                 188    188     0%   13-542
agentos/store/__init__.py                                    24     11    54%   19, 42-58
agentos/store/migrations.py                                 177    177     0%   10-460
agentos/tool/__init__.py                                      3      3     0%   6-9
agentos/tool/dispatch.py                                     41     41     0%   6-140
agentos/tool/verify.py                                       55     55     0%   6-175
agentos/util/__init__.py                                      0      0   100%
agentos/util/ulid.py                                          3      3     0%   3-12
agentos/webui/__init__.py                                     1      0   100%
agentos/webui/agent2_monitor.py                             191    191     0%   7-330
agentos/webui/api/__init__.py                                 2      2     0%   5-7
agentos/webui/api/config.py                                  98     98     0%   9-212
agentos/webui/api/context.py                                 81     81     0%   12-252
agentos/webui/api/events.py                                  78     78     0%   12-182
agentos/webui/api/governance.py                             148    148     0%   14-419
agentos/webui/api/guardians.py                              130    130     0%   12-363
agentos/webui/api/health.py                                  34     34     0%   7-75
agentos/webui/api/history.py                                 88     88     0%   10-242
agentos/webui/api/knowledge.py                              548    548     0%   16-1459
agentos/webui/api/lead.py                                    93     93     0%   10-269
agentos/webui/api/logs.py                                    32     32     0%   7-76
agentos/webui/api/memory.py                                  46     46     0%   9-115
agentos/webui/api/preview.py                                108    108     0%   8-334
agentos/webui/api/projects.py                               198    198     0%   13-527
agentos/webui/api/providers.py                              194    194     0%   10-568
agentos/webui/api/providers_control.py                       41     41     0%   12-110
agentos/webui/api/providers_instances.py                    152    152     0%   13-364
agentos/webui/api/providers_lifecycle.py                    178    178     0%   13-435
agentos/webui/api/runtime.py                                 31     31     0%   9-82
agentos/webui/api/secrets.py                                 79     79     0%   19-226
agentos/webui/api/selfcheck.py                               34     34     0%   13-118
agentos/webui/api/sessions.py                               115    115     0%   18-288
agentos/webui/api/sessions_runtime.py                        66     66     0%   10-179
agentos/webui/api/share.py                                   68     68     0%   9-202
agentos/webui/api/skills.py                                  22     22     0%   8-60
agentos/webui/api/snippets.py                               265    265     0%   12-738
agentos/webui/api/support.py                                 41     41     0%   7-142
agentos/webui/api/task_audit.py                              78     78     0%   9-253
agentos/webui/api/task_dependencies.py                      121    121     0%   8-321
agentos/webui/api/tasks.py                                   71     71     0%   10-194
agentos/webui/app.py                                        117    117     0%   13-257
agentos/webui/auth/__init__.py                                2      2     0%   10-12
agentos/webui/auth/simple_token.py                           37     37     0%   12-119
agentos/webui/daemon.py                                      98     98     0%   7-248
agentos/webui/middleware/__init__.py                          2      2     0%   7-9
agentos/webui/middleware/sanitize.py                         54     54     0%   10-171
agentos/webui/secrets/__init__.py                             2      0   100%
agentos/webui/secrets/store.py                              106     59    44%   58, 67-68, 81, 91-101, 120-126, 134-152, 166-189, 212-218, 230-238, 255-266, 280-282, 300-303
agentos/webui/store/__init__.py                               3      3     0%   14-17
agentos/webui/store/models.py                                37     37     0%   8-109
agentos/webui/store/session_store.py                        164    164     0%   12-477
agentos/webui/websocket/__init__.py                           3      3     0%   5-8
agentos/webui/websocket/chat.py                             189    189     0%   14-498
agentos/webui/websocket/events.py                            67     67     0%   29-173
---------------------------------------------------------------------------------------
TOTAL                                                     32519  25418    22%
=========================== short test summary info ============================
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_task_handler_creates_draft
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_provides_approval_guidance
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_includes_task_id_in_response
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_sets_next_action_to_approve
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_with_no_args_uses_default_title
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_creates_lineage_entry
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_updates_chat_session_metadata
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_message_format
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandler::test_handler_routing_result_in_response
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandlerIntegration::test_create_and_approve_workflow
FAILED tests/unit/chat/test_task_handler.py::TestTaskHandlerIntegration::test_multiple_tasks_from_same_session
FAILED tests/unit/cli/test_project.py::TestImportCommand::test_import_project_from_cli_options
FAILED tests/unit/cli/test_project_trace.py::TestProjectTraceCommand::test_project_not_found
FAILED tests/unit/cli/test_task_trace.py::TestTaskTraceCommand::test_task_trace_table_format
FAILED tests/unit/cli/test_task_trace.py::TestTaskTraceCommand::test_task_not_found
FAILED tests/unit/git/test_probe.py::TestProbeReadAccess::test_successful_read_access
FAILED tests/unit/git/test_probe.py::TestProbeReadAccess::test_read_access_denied_ssh
FAILED tests/unit/git/test_probe.py::TestProbeReadAccess::test_read_access_timeout
FAILED tests/unit/git/test_probe.py::TestDiagnoseError::test_diagnose_ssh_permission_denied
FAILED tests/unit/lead/test_contract_mapper.py::TestMinerToDedupeMapper::test_convert_miner_finding
FAILED tests/unit/lead/test_contract_mapper.py::TestBackwardCompatibility::test_storage_to_miner_compatible_with_original
FAILED tests/unit/lead/test_contract_mapper.py::TestBackwardCompatibility::test_miner_to_dedupe_compatible_with_original
FAILED tests/unit/lead/test_contract_versions.py::test_scan_result_includes_contract_versions
FAILED tests/unit/lead/test_contract_versions.py::test_version_mismatch_allows_dry_run_scan
FAILED tests/unit/lead/test_storage_queries.py::TestGetDecisionLag::test_calculates_p95_lag_correctly
FAILED tests/unit/lead/test_storage_queries.py::TestGetDecisionLag::test_returns_zero_when_no_lag_data
FAILED tests/unit/supervisor/test_event_poller.py::TestGetCheckpoint::test_get_checkpoint_existing
FAILED tests/unit/supervisor/test_event_poller.py::TestConvertToSupervisorEvent::test_convert_basic_row
FAILED tests/unit/supervisor/test_event_poller.py::TestConvertToSupervisorEvent::test_convert_with_payload
FAILED tests/unit/supervisor/test_event_poller.py::TestConvertToSupervisorEvent::test_convert_invalid_json_payload
FAILED tests/unit/supervisor/test_event_poller.py::TestScan::test_scan_with_events
FAILED tests/unit/supervisor/test_event_poller.py::TestScan::test_scan_updates_checkpoint
FAILED tests/unit/supervisor/test_event_poller.py::TestScan::test_scan_incremental
FAILED tests/unit/supervisor/test_event_poller.py::TestScan::test_scan_deduplication
FAILED tests/unit/supervisor/test_event_poller.py::TestScan::test_scan_handles_errors
FAILED tests/unit/supervisor/test_event_poller.py::TestBatchProcessing::test_scan_multiple_batches
FAILED tests/unit/supervisor/test_subscriber.py::TestOnEvent::test_on_event_duplicate_event
FAILED tests/unit/supervisor/test_subscriber.py::TestWakeupBehavior::test_no_wakeup_on_duplicate
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_simple_pattern_matching
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_multiple_patterns
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_wildcard_patterns
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_recursive_wildcard
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_path_normalization
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_filter_files
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_get_allowed_count
FAILED tests/unit/task/test_path_filter.py::TestPathFilter::test_complex_pattern_combination
FAILED tests/unit/task/test_path_filter.py::TestPathFilterBuilder::test_builder_basic
FAILED tests/unit/task/test_path_filter.py::TestPathFilterBuilder::test_builder_include_all
FAILED tests/unit/task/test_path_filter.py::TestPathFilterFactories::test_create_path_filter
FAILED tests/unit/task/test_path_filter.py::TestPathFilterFactories::test_create_full_access_filter
FAILED tests/unit/task/test_path_filter.py::TestPathFilterFactories::test_create_readonly_filter
FAILED tests/unit/task/test_path_filter.py::TestPathFilterEdgeCases::test_root_file
FAILED tests/unit/task/test_path_filter.py::TestPathFilterEdgeCases::test_pattern_with_dots
FAILED tests/unit/task/test_path_filter.py::TestPathFilterEdgeCases::test_case_sensitivity
FAILED tests/unit/task/test_task_api_enforces_state_machine.py::test_cannot_approve_approved_task
FAILED tests/unit/task/test_task_rollback_rules.py::test_restart_creates_new_task
FAILED tests/unit/task/test_task_rollback_rules.py::test_restart_from_any_state
FAILED tests/unit/task/test_task_rollback_rules.py::test_full_rollback_scenario_restart_failed_task
FAILED tests/unit/test_git/test_client.py::TestGitClientWithAuth::test_clone_with_pat_token
FAILED tests/unit/test_git/test_client.py::TestGitClientWithAuth::test_clone_with_ssh_key
FAILED tests/unit/test_git/test_client.py::TestGitClientWithAuth::test_clone_with_env_fallback
FAILED tests/unit/test_git/test_client.py::TestGitClientWithAuth::test_pull_with_auth
FAILED tests/unit/test_git/test_client.py::TestGitClientWithAuth::test_push_with_auth
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceRoot::test_init_with_absolute_path
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceRoot::test_get_projects_dir
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceRoot::test_ensure_projects_dir
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_init - ...
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_get_project_root
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_get_repo_path
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_get_repo_path_with_nested_relpath
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_get_repo_path_with_parent_relpath
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_get_metadata_dir
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_ensure_project_root
FAILED tests/unit/workspace/test_layout.py::TestWorkspaceLayout::test_get_path_mapping
74 failed, 908 passed, 104 warnings in 14.40s
