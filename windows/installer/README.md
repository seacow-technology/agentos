# Windows Installer Skeleton (M3)

## Goal
Deliver a Windows installer with bundled runtime so users can run `octopusos` immediately after installation, without requiring system Python/uv/node.

## Scope (M3)
- Build skeleton for installer pipeline
- Produce deterministic artifact layout under `publish/artifacts/<version>/windows/`
- Run post-install smoke checks (PowerShell)
- Define PATH and uninstall behavior

## Runtime Strategy
- Route: bundled runtime (self-contained distribution)
- Installer must not depend on user-provided Python runtime
- Current toolchain target: WiX v4 MSI (`wix build`)

## Install Targets
- Suggested install path (per-machine): `C:\Program Files\OctopusOS\`
- Data path (runtime): `%LOCALAPPDATA%\OctopusOS\`

## PATH Policy
- Installer should add the CLI directory to Machine PATH (UAC required)
- Command available in a new PowerShell session as `octopusos`

## Uninstall Policy
- Remove installed binaries and PATH entry
- Keep `%LOCALAPPDATA%\OctopusOS\` by default unless explicit purge is selected

## Build Entrypoints
- `publish/windows/installer/build.ps1`
- `publish/windows/installer/smoke.ps1`
- `publish/scripts/build_windows.ps1` (wrapper)
- `publish/scripts/smoke_windows.ps1` (wrapper)
- `publish/windows/installer/wix/Product.wxs` (MSI definition)

## Acceptance (M3)
1. `octopusos --version` works in a fresh PowerShell
2. `octopusos webui start|status|stop` works post-install
3. `octopusos logs --tail --lines 5` works post-install
4. Repeated `octopusos webui start` is idempotent
5. Artifacts and logs are emitted under `publish/artifacts/<version>/windows/`

## WiX Notes
- Uses a fixed `UpgradeCode` for stable upgrade path.
- Uses `MajorUpgrade` for replacing older versions.
- Adds `INSTALLFOLDER` to Machine PATH via MSI `Environment` table.

## Versioning Notes
- MSI `Version` must be numeric `MAJOR.MINOR.PATCH`.
- `build.ps1` derives `msi_version` from OctopusOS full version (e.g. `1.4.2-beta+sha` -> `1.4.2`).
- Full version and channel are preserved in `publish/artifacts/<version>/windows/manifests/manifest.json`.

## Harvest Notes
- Runtime harvesting is generated to a fixed path: `publish/windows/installer/wix/harvest.wxs`.
- Build logs always include harvested file count and harvest output path.
- Harvested component identities are generated by WiX heat and consumed together with `MajorUpgrade`.
- Major upgrades depend on stable component identity conventions; avoid ad-hoc harvest path changes that create non-repeatable MSI composition.
